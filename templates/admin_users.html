<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Admin - User Management</title>
  <style>
    body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; margin: 0; background: #f5f7fa; padding: 20px; color: #333; }
    .panel { background: #fff; border-radius: 8px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); padding: 20px; overflow-x: auto; }
    
    /* Top Navigation Bar */
    .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; border-bottom: 1px solid #eee; padding-bottom: 15px; }
    .nav-links a { text-decoration: none; color: #555; margin-right: 15px; font-weight: 600; padding: 5px 10px; border-radius: 4px; }
    .nav-links a.active { background: #232f3e; color: #fff; }
    .nav-links a:hover { background: #e2e8f0; color: #111; }
    
    table { width: 100%; border-collapse: collapse; min-width: 900px; }
    th { text-align: left; background: #232f3e; color: #fff; padding: 12px; font-size: 0.9em; }
    td { padding: 12px; border-bottom: 1px solid #eee; font-size: 0.9em; vertical-align: top; }
    tr:hover { background: #f9f9f9; }
    
    .btn { padding: 5px 10px; cursor: pointer; border-radius: 4px; font-size: 0.85em; border: 1px solid transparent; margin-right: 5px; }
    .btn-pause { background: #f6ad55; color: #fff; }
    .btn-active { background: #48bb78; color: #fff; }
    .btn-delete { background: #e53e3e; color: #fff; }
    .btn-logout { background: transparent; border: 1px solid #ccc; color: #555; }
    
    .status-paused { background: #ffecec; color: #c53030; padding: 2px 6px; border-radius: 4px; font-weight: bold; font-size: 0.8em; margin-left: 5px; }
    .admin-tag { font-size: 0.8em; color: #2b6cb0; font-weight: bold; margin-left: 5px; }
    
    /* Dropdown Style */
    select { padding: 5px; border-radius: 4px; border: 1px solid #cbd5e0; max-width: 200px; }
  </style>
</head>
<body>

<div class="panel">
  <div class="header">
    <div class="nav-links">
        <a href="{{ url_for('admin_users') }}" class="active">Users</a>
        <a href="{{ url_for('admin_items') }}">Items</a>
    </div>
    <div style="display:flex; align-items:center; gap:10px;">
        <span>Admin Panel</span>
        <form method="post" action="{{ url_for('logout') }}" style="display:inline">
            <button class="btn btn-logout" type="submit">Logout</button>
        </form>
    </div>
  </div>

  <h2>All Registered Users</h2>

  <table>
    <thead>
      <tr>
        <th>Email</th>
        <th>IP / Location</th>
        <th>Device</th>
        <th>Joined / Last Login</th>
        <th>User Items</th>
        <th>Actions</th>
      </tr>
    </thead>
    <tbody>
      {% for u in users %}
      <tr style="{{ 'opacity: 0.6;' if u.is_paused else '' }}">
        <!-- Email -->
        <td>
          <strong>{{ u.email }}</strong>
          {% if u.role == 'admin' %} <span class="admin-tag">(Admin)</span> {% endif %}
          {% if u.is_paused %} <span class="status-paused">PAUSED</span> {% endif %}
        </td>

        <!-- IP & Location -->
        <td>
            <div>{{ u.ip_address if u.ip_address else "-" }}</div>
            <div style="font-size:0.85em; color:#666;">{{ u.location if u.location else "-" }}</div>
        </td>

        <!-- Device -->
        <td title="{{ u.device_name }}">
            <div style="max-width: 150px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">
                {{ u.device_name if u.device_name else "-" }}
            </div>
        </td>

        <!-- Dates -->
        <td>
            <div>C: {{ u.created_at.split(' ')[0] }}</div>
            <div style="font-size:0.85em; color:#666;">L: {{ u.last_login_at if u.last_login_at else "Never" }}</div>
        </td>

        <!-- Dropdown for Items -->
        <td>
            {% if user_items_map[u.id] %}
                <select>
                    <option disabled selected>{{ u.items_count }} Items</option>
                    {% for item in user_items_map[u.id] %}
                        <option>
                            {{ item.asin }} - {{ (item.title or "No Title")[:30] }}...
                        </option>
                    {% endfor %}
                </select>
            {% else %}
                <span style="color:#999; font-size:0.9em;">No items</span>
            {% endif %}
        </td>

        <!-- Actions -->
        <td>
          <div style="display:flex;">
            <form method="post" action="{{ url_for('admin_user_pause', user_id=u.id) }}">
                <button class="btn {{ 'btn-active' if u.is_paused else 'btn-pause' }}" type="submit">
                    {{ 'Unpause' if u.is_paused else 'Pause' }}
                </button>
            </form>

            <form method="post" action="{{ url_for('admin_user_delete', user_id=u.id) }}" onsubmit="return confirm('Permanently delete this user?');">
                <button class="btn btn-delete" type="submit">Delete</button>
            </form>
          </div>
        </td>
      </tr>
      {% endfor %}
    </tbody>
  </table>
</div>

</body>
</html>
