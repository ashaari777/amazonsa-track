<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Dashboard</title>

  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>

  <style>
    :root{
      --bg1:#0b0c1a;
      --bg2:#15163a;
      --card:rgba(25,26,60,.55);
      --stroke:rgba(255,255,255,.08);
      --txt:#e9ecff;
      --muted:rgba(233,236,255,.55);
      --pink:#ff2f7d;
      --green:#2bdc7b;
      --orange:#ff9a21;
    }

    *{box-sizing:border-box}
    body{
      margin:0;
      font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;
      color:var(--txt);
      background: radial-gradient(1200px 900px at 35% 15%, #2b2d7b 0%, rgba(43,45,123,0) 60%),
                  radial-gradient(1000px 700px at 80% 25%, #461c61 0%, rgba(70,28,97,0) 55%),
                  linear-gradient(180deg,var(--bg1),var(--bg2));
      min-height:100vh;
    }

    .layout{
      display:grid;
      grid-template-columns: 220px 1fr;
      min-height:100vh;
    }

    /* Sidebar */
    .side{
      padding:22px 18px;
      background: rgba(10,10,20,.65);
      border-right:1px solid rgba(255,255,255,.06);
      backdrop-filter: blur(12px);
    }
    .side h3{
      margin:0 0 16px;
      font-size:18px;
      letter-spacing:.2px;
    }
    .navbtn{
      width:100%;
      padding:12px 14px;
      border-radius:14px;
      border:1px solid rgba(255,255,255,.08);
      background: rgba(255,255,255,.04);
      color:var(--txt);
      font-weight:700;
      text-align:left;
    }

    /* Main */
    .main{
      padding:22px 18px 40px;
      max-width: 1200px;
      margin: 0 auto;
      width:100%;
    }

    .topbar{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
      margin-bottom:16px;
    }
    .topbar h1{
      margin:0;
      font-size:34px;
      letter-spacing:.3px;
    }

    .search{
      width:100%;
      background: rgba(255,255,255,.04);
      border:1px solid rgba(255,255,255,.08);
      border-radius:18px;
      padding:14px 16px;
      color:var(--txt);
      outline:none;
    }

    .grid{
      display:grid;
      grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
      gap:18px;
      margin-top:18px;
    }

    .card{
      border-radius:26px;
      background: var(--card);
      border:1px solid var(--stroke);
      box-shadow: 0 16px 46px rgba(0,0,0,.35);
      padding:16px 16px 14px;
      overflow:hidden;
      position:relative;
      min-height:420px; /* IMPORTANT: This is the reference height */
      backdrop-filter: blur(10px);
    }

    .title{
      font-weight:900;
      font-size:18px;
      line-height:1.2;
      margin:0 0 10px;
      overflow:hidden;
      display:-webkit-box;
      -webkit-line-clamp:2;
      -webkit-box-orient: vertical;
    }

    .row{
      display:flex;
      align-items:center;
      gap:10px;
      flex-wrap:wrap;
    }

    .price-text{
      font-weight:900;
      font-size:20px;
      color: var(--green);
    }

    .pill{
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding:6px 10px;
      border-radius:999px;
      font-weight:900;
      font-size:14px;
      line-height:1;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.04);
    }

    .pill.low{ color: var(--orange); border-color: rgba(255,154,33,.35); }
    .pill.l{ color: var(--green); border-color: rgba(43,220,123,.35); }
    .pill.h{ color: #ff4f8e; border-color: rgba(255,79,142,.35); }

    /* Coupons: ONE BOX */
    .coupon-box{
      display:inline-flex;
      align-items:center;
      gap:10px;
      padding:7px 12px;
      border-radius:999px;
      border:1px solid rgba(43,220,123,.28);
      background: rgba(43,220,123,.10);
      color: rgba(233,236,255,.95);
      font-weight:900;
      margin-top:8px;
      max-width:100%;
      overflow:hidden;
      white-space:nowrap;
      text-overflow:ellipsis;
    }
    .coupon-box .icon{
      display:inline-flex;
      width:22px;
      height:22px;
      align-items:center;
      justify-content:center;
      border-radius:8px;
      background: rgba(255,255,255,.08);
    }

    /* Chart */
    .chart-wrap{
      margin-top:10px;
      height:250px;
      width:100%;
      position:relative;
    }
    canvas{ width:100% !important; height:100% !important; }

    /* Footer (Target | input | Save .... Delete) */
    .card-footer{
      margin-top:14px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:14px;
    }

    .target-form{
      display:flex;
      align-items:center;
      gap:10px;
      flex:1;
      min-width:0;
    }

    .target-form label{
      font-weight:900;
      color:#d8dbff;
      white-space:nowrap;
    }
    .sep{opacity:.35}

    .target-form input{
      width:160px;
      max-width:160px;
      padding:10px 10px;
      border-radius:10px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(0,0,0,.25);
      color:var(--txt);
      outline:none;
      font-weight:900;
    }

    .savebtn{
      padding:10px 12px;
      border-radius:10px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.06);
      color:var(--txt);
      font-weight:900;
      cursor:pointer;
    }

    .del{
      color:#ff2f55;
      font-weight:900;
      text-decoration:none;
    }

    /* ===== Marketing card ===== */
    .marketing-card{
      width: 100%;
      height: 420px; /* EXACT SAME HEIGHT as .card */
      border-radius: 26px;
      background: rgba(25,26,60,.55);
      border: 1px solid rgba(255,255,255,.08);
      box-shadow: 0 16px 46px rgba(0,0,0,.35);
      overflow: hidden;
      padding: 12px;
      backdrop-filter: blur(10px);
    }

    .marketing-head{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      margin: 4px 4px 10px;
    }
    .marketing-head .h{
      font-weight: 1000;
      font-size: 18px;
      margin:0;
    }
    .marketing-head .sub{
      font-size: 12px;
      color: var(--muted);
      font-weight: 800;
    }

    .marketing-list{
      height: calc(100% - 46px);
      display:flex;
      flex-direction:column;
      gap: 10px;
    }

    .marketing-banner{
      flex:1;
      min-height:0;
      border-radius: 18px;
      position:relative;
      overflow:hidden;
      background: url("/static/img/marketing_banner.png") center / cover no-repeat;
      filter: drop-shadow(0 6px 14px rgba(0,0,0,.35));
    }

    .marketing-banner::before{
      content:"";
      position:absolute; inset:0;
      background: linear-gradient(90deg, rgba(0,0,0,.22), rgba(0,0,0,.02));
    }

    .marketing-content{
      position:relative;
      height:100%;
      display:grid;
      grid-template-columns: 1.3fr 0.55fr 0.65fr;
      align-items:center;
      gap: 10px;
      padding: 10px 14px;
    }

    .m-title{
      font-weight: 1000;
      color:#2b2b2b;
      font-size: 14px;
      overflow:hidden;
      white-space:nowrap;
      text-overflow:ellipsis;
      text-shadow: 0 1px 0 rgba(255,255,255,.35);
    }

    .m-price{
      font-weight: 1000;
      color:#2b2b2b;
      font-size: 16px;
      margin-top:4px;
      text-shadow: 0 1px 0 rgba(255,255,255,.35);
    }

    .m-discount{
      justify-self:end;
      display:flex;
      align-items:baseline;
      gap:6px;
    }
    .m-discount .num{
      font-weight: 1000;
      font-size: 28px;
      color:#111;
    }
    .m-discount .pct{
      font-weight: 1000;
      font-size: 18px;
      color:#111;
      opacity:.9;
    }

    .m-add{
      justify-self:end;
      display:inline-flex;
      align-items:center;
      justify-content:center;
      padding: 8px 16px;
      border-radius:999px;
      border:none;
      cursor:pointer;
      font-weight: 1000;
      color:#fff;
      background: linear-gradient(180deg, #ff9a21, #e56e05);
      box-shadow: 0 8px 18px rgba(0,0,0,.25);
    }
    .m-add:active{ transform: scale(.98); }

    @media (max-width: 920px){
      .layout{grid-template-columns: 1fr;}
      .side{display:none;}
      .card, .marketing-card{ min-height: 410px; height:auto; }
      .marketing-card{ height:auto; }
      .marketing-list{ height:auto; }
      .marketing-banner{ height: 92px; flex: unset; }
    }
  </style>
</head>

<body>
<div class="layout">

  <aside class="side">
    <h3>User</h3>
    <button class="navbtn">Dashboard</button>
  </aside>

  <main class="main">

    <div class="topbar">
      <h1>Dashboard</h1>
    </div>

    <!-- Add item box -->
    <form method="POST" action="{{ url_for('add') }}">
      <input class="search" name="item" placeholder="Paste Amazon.sa link or ASIN..." autocomplete="off"/>
    </form>

    <!-- ==============================
         MARKETING SECTION (5 banners)
         ============================== -->

    {# Build a set of ASINs the user already has #}
    {% set user_asins = [] %}
    {% for it in items %}
      {% if it.asin %}
        {% set _ = user_asins.append(it.asin) %}
      {% endif %}
    {% endfor %}

    {# deals comes from backend (marketing_items) or fallback to items #}
    {% set deals = marketing_items if marketing_items is defined else items %}

    {# Filter out deals that user already has #}
    {% set filtered_deals = [] %}
    {% for d in deals %}
      {% if d.asin and (d.asin not in user_asins) %}
        {% set _ = filtered_deals.append(d) %}
      {% endif %}
    {% endfor %}

    {% if filtered_deals|length > 0 %}
    <div class="grid">
      <div class="marketing-card">
        <div class="marketing-head">
          <div>
            <div class="h">üî• Trending Deals</div>
            <div class="sub">Updated automatically ‚Ä¢ Click add to monitor</div>
          </div>
        </div>

        <div class="marketing-list">
          {% for d in filtered_deals[:5] %}

            {# Find max percent from coupon_text: "%20 | %25 | %10" #}
            {% set pmax = 0 %}
            {% if d.coupon_text %}
              {% for part in d.coupon_text.split('|') %}
                {% set cleaned = part.replace('%','').replace(' ','') %}
                {% if cleaned.isdigit() %}
                  {% set val = cleaned|int %}
                  {% if val > pmax %}
                    {% set pmax = val %}
                  {% endif %}
                {% endif %}
              {% endfor %}
            {% endif %}

            <div class="marketing-banner">
              <div class="marketing-content">

                <div>
                  <div class="m-title">{{ d.latest_name or d.item_name or d.title or d.asin }}</div>
                  <div class="m-price">
                    {% if d.latest_price_text %}{{ d.latest_price_text }}
                    {% elif d.price_text %}{{ d.price_text }}
                    {% elif d.latest_price_value %}SAR {{ "%.2f"|format(d.latest_price_value) }}
                    {% elif d.price_value %}SAR {{ "%.2f"|format(d.price_value) }}
                    {% else %}SAR --.--{% endif %}
                  </div>
                </div>

                <div class="m-discount">
                  <span class="num">{{ pmax }}</span>
                  <span class="pct">%</span>
                </div>

                <form method="POST" action="{{ url_for('add') }}" style="margin:0;">
                  <input type="hidden" name="item" value="{{ d.asin }}">
                  <button class="m-add" type="submit">add</button>
                </form>

              </div>
            </div>
          {% endfor %}
        </div>
      </div>
    </div>
    {% endif %}

    <!-- ==============================
         USER ITEMS
         ============================== -->

    <div class="grid">

      {% for it in items %}
      <div class="card">

        <div class="title">{{ it.latest_name or it.item_name or it.asin }}</div>

        <!-- Current + L + H + Low -->
        <div class="row">
          <div class="price-text">{{ it.latest_price_text or "SAR --.--" }}</div>

          <div class="pill l">L: <span class="low-val">--</span></div>
          <div class="pill h">H: <span class="high-val">--</span></div>

          <div class="pill low low-badge" style="display:none;">üî• Low</div>
        </div>

        <!-- Coupons ONE box -->
        {% if it.coupon_text %}
          <div class="coupon-box">
            <span class="icon">üéüÔ∏è</span>
            <span>{{ it.coupon_text }}</span>
          </div>
        {% endif %}

        <div class="chart-wrap">
          <canvas id="c{{ it.asin }}"></canvas>
        </div>

        <div class="card-footer">
          <form class="target-form" method="POST" action="{{ url_for('set_target', asin=it.asin) }}">
            <label>Target price:</label>
            <span class="sep">|</span>
            <input name="target_price" value="{{ it.target_price or '' }}" placeholder="SAR">
            <span class="sep">|</span>
            <button class="savebtn" type="submit">Save</button>
          </form>

          <a class="del" href="{{ url_for('delete_item', asin=it.asin) }}">Delete</a>
        </div>

      </div>
      {% endfor %}

    </div>

  </main>
</div>

<script>
  function moneyNum(x){
    if(x === null || x === undefined) return null;
    let n = Number(x);
    if(Number.isFinite(n)) return n;
    return null;
  }

  async function loadHistory(asin){
    const res = await fetch(`/history/${asin}.json?t=${Date.now()}`);
    if(!res.ok) return [];
    return await res.json();
  }

  function fmt(n){
    if(n === null || n === undefined) return "--";
    return Number(n).toFixed(2);
  }

  async function initCard(asin){
    const el = document.getElementById(`c${asin}`);
    if(!el) return;

    const card = el.closest(".card");
    const lowEl = card.querySelector(".low-val");
    const highEl = card.querySelector(".high-val");
    const lowBadge = card.querySelector(".low-badge");

    const data = await loadHistory(asin);

    const pts = data.map(r => ({
      x: r.ts,
      y: moneyNum(r.price_value)
    })).filter(p => p.y !== null);

    if(pts.length === 0){
      lowEl.textContent = "--";
      highEl.textContent = "--";
      lowBadge.style.display = "none";
      return;
    }

    const prices = pts.map(p => p.y);
    const low = Math.min(...prices);
    const high = Math.max(...prices);
    const cur = pts[pts.length - 1].y;

    lowEl.textContent = fmt(low);
    highEl.textContent = fmt(high);

    // üî• Low only if there is a real range AND current == low
    if(cur === low && low !== high){
      lowBadge.style.display = "inline-flex";
    }else{
      lowBadge.style.display = "none";
    }

    // If only 1 point, duplicate it with a fake x so Chart.js centers better
    let chartPts = pts;
    if(pts.length === 1){
      const t = new Date(pts[0].x);
      const left = new Date(t.getTime() - 30*60*1000);
      const right = new Date(t.getTime() + 30*60*1000);
      chartPts = [
        {x:left.toISOString(), y: pts[0].y},
        {x:right.toISOString(), y: pts[0].y}
      ];
    }

    new Chart(el, {
      type: "line",
      data: {
        datasets: [{
          data: chartPts,
          tension: 0.25,
          fill: true,
          borderWidth: 3,
          pointRadius: pts.length === 1 ? 0 : 0,
          pointHoverRadius: 4,
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          legend: { display:false },
          tooltip: { enabled:true }
        },
        scales: {
          x: {
            type: "time",
            offset: true,
            ticks: { color: "rgba(233,236,255,.35)", maxTicksLimit: 4 },
            grid: { color: "rgba(255,255,255,.05)" }
          },
          y: {
            position: "left",
            ticks: { color: "rgba(233,236,255,.35)" },
            grid: { color: "rgba(255,255,255,.05)" }
          }
        }
      }
    });
  }

  // Init all cards
  document.querySelectorAll("canvas[id^='c']").forEach(c => {
    const asin = c.id.substring(1);
    initCard(asin);
  });
</script>

</body>
</html>
