<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Price Tracker</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800;900&family=Sora:wght@400;600;700;800&display=swap" rel="stylesheet">
  <style>
    :root{
      --bg:#0f0c29;
      --sidebar:#16162d;
      --card-bg:rgba(30,30,50,0.55);
      --border:rgba(255,255,255,0.10);
      --text:rgba(255,255,255,0.95);
      --text-muted:rgba(255,255,255,0.65);
      --accent:#d53369;
      --gold:#daae51;
      --orange:#ff9c66;
      --orange-2:#ff7c55;
      --desktop-bg-1:#07101d;
      --desktop-bg-2:#0a1826;
      --desktop-bg-3:#0e2233;
      --desktop-panel:#243241;
      --desktop-panel-2:#2b3a49;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      min-height:100vh;
      font-family:'Inter',sans-serif;
      background:var(--bg);
      color:var(--text);
      display:flex;
    }

    a{color:inherit}
    .desktop-only{display:block}
    .mobile-only{display:none}

    .sidebar{
      width:250px;
      padding:24px;
      position:fixed;
      top:0;
      bottom:0;
      left:0;
      display:flex;
      flex-direction:column;
      gap:14px;
      background:
        linear-gradient(180deg, rgba(56,71,88,0.96), rgba(48,60,74,0.98)),
        linear-gradient(180deg, rgba(255,255,255,0.04), rgba(255,255,255,0));
      border-right:1px solid rgba(180,219,246,0.10);
    }
    .user-email-top{
      display:flex;
      align-items:center;
      gap:10px;
      font-size:1.25rem;
      font-weight:800;
      letter-spacing:-0.02em;
      color:#fff;
      margin-bottom:8px;
    }
    .brand-dot{
      width:26px;
      height:26px;
      border-radius:50%;
      background:linear-gradient(135deg, var(--orange), var(--orange-2));
      display:grid;
      place-items:center;
      color:#fff;
      font-size:.95rem;
      box-shadow:0 8px 18px rgba(255,129,84,0.28);
      flex:none;
    }
    .nav-item{
      padding:12px 14px;
      border-radius:14px;
      text-decoration:none;
      color:#d8e8f4;
      font-weight:700;
      display:flex;
      justify-content:space-between;
      align-items:center;
      background:rgba(255,255,255,0.03);
      border:1px solid rgba(255,255,255,0.04);
      width:100%;
      cursor:pointer;
      text-align:left;
      font-family:inherit;
      font-size:.98rem;
    }
    .nav-item.active{
      background:rgba(8,14,22,0.62);
      box-shadow:inset 0 1px 0 rgba(255,255,255,0.05);
    }
    .nav-item:hover{background:rgba(255,255,255,0.06)}
    .nav-item.alert-off{color:#ffe6b7}
    .nav-item.alert-on{color:#a8ffd7}
    .sidebar form{margin:0}
    .logout-nav{
      margin-top:auto;
    }

    .main{
      margin-left:250px;
      flex:1;
      width:100%;
      min-height:100vh;
      padding:28px 32px;
    }

    .banner{
      padding:15px 16px;
      border-radius:14px;
      margin-bottom:18px;
      border:1px solid rgba(255,255,255,0.16);
      background:rgba(255,255,255,0.08);
      color:#fff;
      font-weight:600;
    }
    .banner.announcement{
      background:rgba(213,51,105,0.18);
      border-color:rgba(213,51,105,0.30);
    }

    .desktop-shell{
      border-radius:28px;
      padding:18px;
      border:1px solid rgba(125,231,255,0.14);
      background:
        linear-gradient(180deg, rgba(255,255,255,0.03), rgba(255,255,255,0.015)),
        linear-gradient(145deg, rgba(66,112,155,0.16), rgba(18,29,43,0.14));
      box-shadow:0 28px 80px rgba(0,0,0,0.32);
      overflow:hidden;
    }
    .desktop-topbar{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:18px;
      margin-bottom:16px;
    }
    .desktop-title{
      display:flex;
      flex-direction:column;
      gap:4px;
      min-width:0;
    }
    .desktop-title h1{
      margin:0;
      font-family:'Sora','Inter',sans-serif;
      font-size:1.9rem;
      font-weight:800;
      letter-spacing:-0.03em;
    }
    .desktop-sub{
      color:#8faac0;
      font-size:.9rem;
      font-weight:600;
    }
    .desktop-right{
      display:flex;
      align-items:center;
      gap:10px;
      flex-wrap:wrap;
      justify-content:flex-end;
    }
    .desktop-count{
      padding:10px 14px;
      border-radius:14px;
      background:rgba(255,255,255,0.03);
      border:1px solid rgba(255,255,255,0.05);
      color:#d8e8f4;
      font-weight:800;
      font-size:.88rem;
    }
    .desktop-time{
      color:#8faac0;
      font-size:.88rem;
      font-weight:700;
    }
    .desktop-add-form{
      display:flex;
      align-items:center;
      gap:10px;
      width:100%;
      margin-bottom:16px;
    }
    .desktop-search{
      flex:1;
      min-width:0;
      height:48px;
      border-radius:16px;
      border:1px solid rgba(203,229,247,0.08);
      background:rgba(255,255,255,0.03);
      color:#fff;
      padding:0 16px;
      font-size:.96rem;
      outline:none;
    }
    .desktop-search::placeholder{color:#90a9be}
    .orange-btn{
      height:48px;
      border:none;
      border-radius:16px;
      padding:0 18px;
      background:linear-gradient(135deg, var(--orange), var(--orange-2));
      color:#fff;
      font-weight:800;
      font-family:inherit;
      cursor:pointer;
      box-shadow:0 12px 28px rgba(255,129,84,0.20);
    }

    .desktop-range{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:14px;
      margin-bottom:14px;
      flex-wrap:wrap;
    }
    .desktop-range-title{
      color:#9fb7c8;
      font-size:.88rem;
      font-weight:800;
      letter-spacing:.02em;
    }
    .range-tabs{
      display:flex;
      gap:8px;
      flex-wrap:wrap;
    }
    .range-btn{
      border:1px solid rgba(255,255,255,0.06);
      background:rgba(255,255,255,0.04);
      color:#9fb6c7;
      padding:6px 11px;
      border-radius:10px;
      cursor:pointer;
      font-weight:850;
      font-size:.8rem;
      min-width:46px;
      font-family:inherit;
    }
    .range-btn.active{
      background:rgba(255,255,255,0.10);
      color:#fff;
      border-color:rgba(255,255,255,0.10);
    }

    .desktop-strip-wrap{
      position:relative;
      margin-bottom:16px;
      padding:0 44px;
    }
    .desktop-strip{
      display:grid;
      grid-auto-flow:column;
      grid-auto-columns:minmax(255px, 255px);
      gap:12px;
      overflow-x:auto;
      scroll-behavior:smooth;
      scrollbar-width:none;
      padding-bottom:4px;
    }
    .desktop-strip::-webkit-scrollbar{display:none}
    .slider-btn{
      position:absolute;
      top:50%;
      transform:translateY(-50%);
      width:34px;
      height:34px;
      border-radius:50%;
      border:1px solid rgba(255,255,255,0.08);
      background:rgba(255,255,255,0.05);
      color:#d8e8f4;
      font-size:1rem;
      font-weight:900;
      cursor:pointer;
      display:grid;
      place-items:center;
      z-index:2;
    }
    .slider-btn.left{left:0}
    .slider-btn.right{right:0}
    .slider-btn[disabled]{
      opacity:.35;
      cursor:default;
    }

    .desktop-item-card{
      border-radius:24px;
      border:1px solid rgba(201,232,255,0.08);
      background:
        linear-gradient(180deg, rgba(255,255,255,0.03), rgba(255,255,255,0.015)),
        linear-gradient(180deg, rgba(49,68,86,0.92), rgba(34,49,64,0.95));
      box-shadow:inset 0 1px 0 rgba(255,255,255,0.03);
      padding:14px;
      display:grid;
      grid-template-rows:auto auto auto auto auto;
      gap:10px;
      min-height:232px;
      color:#eef7ff;
    }
    .desktop-item-card.active{
      border-color:rgba(255,156,102,0.35);
      box-shadow:inset 0 1px 0 rgba(255,255,255,0.04), 0 0 0 1px rgba(255,156,102,0.08);
    }
    .desktop-item-title{
      font-size:.95rem;
      line-height:1.28;
      font-weight:800;
      min-height:40px;
      display:-webkit-box;
      -webkit-line-clamp:2;
      -webkit-box-orient:vertical;
      overflow:hidden;
      text-decoration:none;
    }
    .desktop-item-title:hover{
      text-decoration:underline;
      text-decoration-color:rgba(255,156,102,0.75);
      text-underline-offset:2px;
    }
    .desktop-seller{
      font-size:.8rem;
      font-weight:700;
      color:#9db5c8;
      min-height:18px;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }
    .desktop-pills{
      display:grid;
      grid-template-columns:repeat(3, minmax(0,1fr));
      gap:6px;
    }
    .desktop-pill{
      min-height:33px;
      border-radius:12px;
      padding:0 8px;
      display:flex;
      align-items:center;
      justify-content:center;
      text-align:center;
      font-size:.72rem;
      font-weight:800;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
      border:1px solid rgba(255,255,255,0.06);
      background:rgba(255,255,255,0.05);
      color:#eef7ff;
    }
    .desktop-pill.low{color:#66d9cc}
    .desktop-pill.high{color:#f0a5c7}
    .desktop-target-row{
      display:grid;
      grid-template-columns:minmax(0,1fr) 72px;
      gap:8px;
    }
    .desktop-target-box{
      height:38px;
      border-radius:14px;
      border:1px solid rgba(255,255,255,0.06);
      background:rgba(255,255,255,0.04);
      display:flex;
      align-items:center;
      gap:8px;
      padding:0 10px;
      min-width:0;
    }
    .desktop-target-box label{
      font-size:.74rem;
      font-weight:700;
      color:#8ea8bc;
      white-space:nowrap;
    }
    .desktop-target-input{
      flex:1;
      min-width:0;
      border:none;
      outline:none;
      background:transparent;
      color:#fff;
      font-size:.8rem;
      font-weight:700;
      font-family:inherit;
    }
    .desktop-set-btn{
      height:38px;
      border:none;
      border-radius:14px;
      background:linear-gradient(135deg, var(--orange), var(--orange-2));
      color:#fff;
      font-size:.78rem;
      font-weight:800;
      font-family:inherit;
      cursor:pointer;
      box-shadow:0 10px 22px rgba(255,129,84,0.18);
    }
    .desktop-action-row{
      display:grid;
      grid-template-columns:1fr 1fr;
      gap:8px;
    }
    .desktop-action-row form{
      margin:0;
    }
    .desktop-action-btn{
      height:38px;
      width:100%;
      border-radius:14px;
      border:1px solid rgba(255,255,255,0.06);
      background:rgba(255,255,255,0.05);
      color:var(--orange);
      font-size:.78rem;
      font-weight:800;
      font-family:inherit;
      cursor:pointer;
    }

    .desktop-main-grid{
      display:grid;
      grid-template-columns:minmax(0,1fr) 300px;
      gap:14px;
      min-height:0;
    }
    .desktop-chart-panel,
    .desktop-deals-panel{
      border-radius:24px;
      border:1px solid rgba(201,232,255,0.08);
      background:
        linear-gradient(180deg, rgba(255,255,255,0.03), rgba(255,255,255,0.015)),
        linear-gradient(180deg, rgba(49,68,86,0.92), rgba(34,49,64,0.95));
      box-shadow:inset 0 1px 0 rgba(255,255,255,0.03);
    }
    .desktop-chart-panel{
      padding:16px;
      display:grid;
      grid-template-rows:auto auto 1fr;
      gap:12px;
      min-width:0;
    }
    .desktop-chart-head{
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap:12px;
    }
    .desktop-chart-title{
      display:flex;
      flex-direction:column;
      gap:4px;
      min-width:0;
    }
    .desktop-chart-title a{
      font-family:'Sora','Inter',sans-serif;
      font-size:1.05rem;
      font-weight:800;
      text-decoration:none;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }
    .desktop-chart-title a:hover{
      text-decoration:underline;
      text-decoration-color:rgba(255,156,102,0.75);
      text-underline-offset:2px;
    }
    .desktop-chart-seller{
      color:#8faac0;
      font-size:.82rem;
      font-weight:700;
      min-height:16px;
    }
    .desktop-chart-stats{
      display:grid;
      grid-template-columns:repeat(3, minmax(0,1fr));
      gap:8px;
    }
    .desktop-stat{
      min-height:34px;
      border-radius:12px;
      border:1px solid rgba(255,255,255,0.06);
      background:rgba(255,255,255,0.05);
      display:flex;
      align-items:center;
      justify-content:center;
      padding:0 8px;
      font-size:.8rem;
      font-weight:800;
      color:#eef7ff;
    }
    .desktop-stat.low{color:#66d9cc}
    .desktop-stat.high{color:#f0a5c7}
    .desktop-canvas-wrap{
      position:relative;
      border-radius:18px;
      border:1px solid rgba(205,233,250,0.05);
      background:
        radial-gradient(circle at 84% 30%, rgba(255,76,204,0.14), transparent 18%),
        radial-gradient(circle at 24% 28%, rgba(33,161,255,0.10), transparent 18%),
        linear-gradient(180deg, rgba(40,58,75,0.95), rgba(30,44,57,0.96));
      padding:12px 14px 38px;
      overflow:hidden;
    }
    .desktop-canvas-wrap canvas{
      width:100%;
      height:360px !important;
      display:block;
    }
    .desktop-chart-date{
      position:absolute;
      left:14px;
      right:14px;
      bottom:12px;
      color:#8ca7bc;
      font-size:.78rem;
      font-weight:700;
      min-height:18px;
    }

    .desktop-deals-panel{
      padding:16px;
      display:flex;
      flex-direction:column;
      gap:12px;
    }
    .desktop-deals-panel h3{
      margin:0;
      font-family:'Sora','Inter',sans-serif;
      font-size:1.05rem;
      font-weight:800;
    }
    .desktop-deals-panel p{
      margin:4px 0 0;
      color:#8faac0;
      font-size:.82rem;
      font-weight:600;
    }
    .desktop-deals-list{
      display:flex;
      flex-direction:column;
      gap:10px;
    }
    .desktop-deal{
      border-radius:16px;
      border:1px solid rgba(255,255,255,0.05);
      background:rgba(255,255,255,0.03);
      padding:12px;
    }
    .desktop-deal-title{
      font-size:.8rem;
      line-height:1.35;
      font-weight:800;
      margin:0 0 7px 0;
      display:-webkit-box;
      -webkit-line-clamp:2;
      -webkit-box-orient:vertical;
      overflow:hidden;
    }
    .desktop-deal-meta{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:8px;
      font-size:.76rem;
      font-weight:800;
      color:#afc5d3;
    }
    .desktop-deal-actions{
      display:flex;
      align-items:center;
      gap:8px;
      margin-top:8px;
    }
    .desktop-badge{
      border-radius:999px;
      padding:4px 8px;
      background:rgba(255,255,255,0.05);
      color:var(--orange);
      border:1px solid rgba(255,255,255,0.06);
      font-size:.72rem;
      font-weight:800;
    }
    .desktop-empty{
      padding:40px 18px;
      border-radius:24px;
      border:1px solid rgba(201,232,255,0.08);
      background:
        linear-gradient(180deg, rgba(255,255,255,0.03), rgba(255,255,255,0.015)),
        linear-gradient(180deg, rgba(49,68,86,0.92), rgba(34,49,64,0.95));
      text-align:center;
      color:#8faac0;
    }

    .header{
      display:flex;
      justify-content:space-between;
      align-items:center;
      margin-bottom:22px;
      gap:14px;
    }
    .header-left{
      display:flex;
      flex-direction:column;
      gap:4px;
    }
    .header h1{
      font-size:1.8rem;
      font-weight:800;
      margin:0;
    }
    .last-update{
      color:var(--text-muted);
      font-weight:600;
    }
    .header-right{
      display:flex;
      align-items:center;
      gap:10px;
    }
    .top-btn{
      border:1px solid rgba(255,255,255,0.16);
      background:rgba(0,0,0,0.20);
      color:#fff;
      padding:10px 14px;
      border-radius:14px;
      cursor:pointer;
      font-weight:800;
      font-family:inherit;
    }
    .mobile-header{display:none}

    .add-panel{
      background:var(--card-bg);
      border:1px solid var(--border);
      border-radius:20px;
      padding:20px;
      margin-bottom:22px;
      display:flex;
      align-items:center;
      gap:15px;
      backdrop-filter:blur(10px);
    }
    .search-input{
      flex:1;
      padding:14px;
      font-size:1rem;
      border-radius:14px;
      border:1px solid rgba(255,255,255,0.15);
      background:rgba(0,0,0,0.25);
      color:white;
      outline:none;
    }
    .btn-glow{
      padding:14px 24px;
      border-radius:14px;
      border:none;
      cursor:pointer;
      font-weight:900;
      font-size:1rem;
      color:#fff;
      background:linear-gradient(135deg, #d53369, #daae51);
      box-shadow:0 10px 30px rgba(213,51,105,0.35);
      transition:0.2s;
    }
    .btn-glow:hover{transform:translateY(-2px)}
    .btn-outline{
      padding:12px 18px;
      border-radius:14px;
      border:1px solid rgba(255,255,255,0.18);
      background:rgba(0,0,0,0.18);
      font-weight:900;
      cursor:pointer;
      font-family:inherit;
      color:rgba(255,90,90,0.95);
    }

    .range-panel{
      background:var(--card-bg);
      border:1px solid var(--border);
      border-radius:16px;
      padding:12px 14px;
      margin-bottom:16px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      flex-wrap:wrap;
      backdrop-filter:blur(10px);
    }
    .range-title{
      color:var(--text-muted);
      font-weight:800;
      font-size:.86rem;
      letter-spacing:.2px;
    }

    .grid{
      display:grid;
      grid-template-columns:repeat(auto-fill, minmax(320px, 1fr));
      gap:25px;
    }
    .card{
      background:var(--card-bg);
      border:1px solid var(--border);
      border-radius:20px;
      padding:20px;
      display:flex;
      flex-direction:column;
      overflow:hidden;
      min-height:480px;
      max-height:580px;
    }
    .card-head{
      display:flex;
      justify-content:space-between;
      align-items:flex-start;
      gap:12px;
      margin-bottom:10px;
    }
    .title-wrap{
      flex:1;
      min-width:0;
    }
    .item-title{
      font-weight:900;
      font-size:1rem;
      line-height:1.25;
      margin:0;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
      max-width:100%;
    }
    .item-title-link{
      color:inherit;
      text-decoration:none;
    }
    .item-title-link:hover{
      text-decoration:underline;
      text-decoration-color:rgba(218,174,81,0.75);
      text-underline-offset:2px;
    }
    .seller-line{
      margin-top:6px;
      color:rgba(255,255,255,0.72);
      font-size:.85rem;
      font-weight:600;
    }
    .meta-row{
      display:flex;
      justify-content:space-between;
      gap:10px;
      margin-top:8px;
      align-items:center;
    }
    .pills{
      display:flex;
      gap:8px;
      flex-wrap:wrap;
    }
    .pill{
      font-size:.78rem;
      font-weight:850;
      padding:6px 10px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,0.16);
      background:rgba(0,0,0,0.22);
      color:#fff;
      line-height:1;
      display:flex;
      gap:6px;
      align-items:center;
      white-space:nowrap;
    }
    .pill-coupon,
    .pill-low{
      color:#2ee59d;
      border-color:rgba(46,229,157,0.35);
      background:rgba(46,229,157,0.10);
    }
    .pill-high{
      color:rgba(255,90,90,0.95);
      border-color:rgba(255,90,90,0.35);
      background:rgba(255,90,90,0.10);
    }
    .coupon-expand{
      margin-top:10px;
      padding:10px 12px;
      border-radius:14px;
      border:1px solid rgba(46,229,157,0.25);
      background:rgba(0,0,0,0.22);
      color:rgba(46,229,157,0.95);
      font-size:.86rem;
      line-height:1.25;
      display:none;
    }
    .chart-box{
      flex:1;
      min-height:180px;
      max-height:250px;
      width:100%;
      margin-top:auto;
      margin-bottom:12px;
    }
    .chart-info{display:none}
    .chart-date{
      display:block;
      margin-top:6px;
      color:rgba(255,255,255,0.72);
      font-size:.82rem;
      font-weight:700;
      min-height:18px;
    }
    .actions-row{
      display:grid;
      grid-template-columns:minmax(0,1fr) auto;
      gap:10px;
      margin-top:10px;
      align-items:stretch;
    }
    .actions-row form{margin:0}
    .target-box{
      display:flex;
      gap:8px;
      align-items:center;
      border-radius:14px;
      padding:8px 12px;
      border:1px solid rgba(255,255,255,0.12);
      background:rgba(0,0,0,0.20);
      min-width:0;
    }
    .target-label{
      color:rgba(255,255,255,0.75);
      font-weight:700;
      font-size:.85rem;
      white-space:nowrap;
    }
    .target-input{
      flex:1;
      min-width:60px;
      max-width:100px;
      border-radius:10px;
      padding:7px 9px;
      border:1px solid rgba(255,255,255,0.15);
      background:rgba(0,0,0,0.30);
      color:#fff;
      outline:none;
      font-size:.9rem;
    }
    .target-submit-btn{
      padding:7px 12px;
      border-radius:10px;
      border:none;
      background:linear-gradient(135deg, #d53369, #daae51);
      color:#fff;
      font-weight:800;
      cursor:pointer;
      font-size:.85rem;
      font-family:inherit;
    }
    .del-btn{
      padding:8px 14px;
      border-radius:14px;
      border:1px solid rgba(255,255,255,0.12);
      background:rgba(0,0,0,0.20);
      color:rgba(255,90,90,0.95);
      font-weight:900;
      cursor:pointer;
      font-size:.85rem;
      min-height:40px;
      font-family:inherit;
    }
    .delete-form{
      display:flex;
      align-items:center;
    }

    .marketing-head{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
      margin-bottom:12px;
    }
    .marketing-head h2{
      font-size:1.05rem;
      font-weight:900;
      margin:0;
    }
    .marketing-list{
      display:flex;
      flex-direction:column;
      gap:12px;
      overflow-y:auto;
      max-height:420px;
      padding-right:4px;
    }
    .deal-banner{
      position:relative;
      overflow:hidden;
      border-radius:14px;
      border:2px solid rgba(255,190,90,0.55);
      background:
        radial-gradient(120% 200% at 0% 0%, rgba(255,225,155,0.55), rgba(255,180,60,0.20) 45%, rgba(255,150,40,0.10) 70%, rgba(0,0,0,0) 100%),
        linear-gradient(180deg, rgba(255,232,170,0.60), rgba(255,198,80,0.28));
      padding:10px 12px 9px;
    }
    .deal-banner::before{
      content:"";
      position:absolute;
      inset:6px;
      border-radius:10px;
      border:2px dashed rgba(255,220,160,0.70);
      opacity:.7;
      pointer-events:none;
    }
    .deal-top{
      position:relative;
      z-index:1;
      margin-bottom:6px;
    }
    .deal-title{
      font-weight:950;
      font-size:.88rem;
      line-height:1.15;
      color:rgba(40,30,18,0.95);
      max-width:100%;
      overflow:hidden;
      text-overflow:ellipsis;
      white-space:nowrap;
    }
    .deal-body{
      position:relative;
      z-index:1;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:8px;
    }
    .deal-price{
      font-size:1.25rem;
      font-weight:1000;
      color:rgba(35,25,12,0.95);
      white-space:nowrap;
    }
    .deal-mid{
      display:flex;
      align-items:center;
      gap:7px;
      margin-left:auto;
    }
    .deal-divider{
      width:1px;
      height:28px;
      background:rgba(40,30,18,0.22);
    }
    .deal-off{
      font-size:1.25rem;
      font-weight:1000;
      color:rgba(30,20,10,0.95);
      white-space:nowrap;
    }
    .deal-add-btn{
      background:linear-gradient(180deg, rgba(255,165,65,0.98), rgba(245,125,35,0.98));
      border:0;
      color:rgba(255,255,255,0.96);
      font-weight:950;
      font-size:.85rem;
      padding:6px 16px;
      border-radius:999px;
      cursor:pointer;
      font-family:inherit;
    }

    @media (max-width:900px){
      .desktop-only{display:none !important}
      .mobile-only{display:block}
      body{display:block}
      .sidebar{display:none}
      .main{
        margin-left:0;
        padding:20px;
      }
      .header{display:none}
      .mobile-header{
        display:flex;
        justify-content:space-between;
        align-items:center;
        margin-bottom:20px;
        gap:12px;
      }
      .mobile-header h1{
        font-size:1.5rem;
        font-weight:900;
        margin:0;
      }
      .mobile-header .right{
        display:flex;
        align-items:center;
        gap:10px;
      }
      .actions-row{
        gap:8px;
        grid-template-columns:1fr;
      }
      .delete-form{width:100%}
      .del-btn{width:100%}
    }
  </style>
</head>
<body>

  <div class="sidebar desktop-only">
    <div class="user-email-top"><span class="brand-dot">+</span> Alerts</div>
    <div class="nav-item active"><span>Dashboard</span></div>
    {% if is_admin %}
      <a href="{{ url_for('admin_portal') }}" class="nav-item"><span>Admin</span></a>
    {% endif %}
    {% if not user.get('telegram_chat_id') %}
      <a href="{{ url_for('telegram_setup') }}" class="nav-item alert-off"><span>ðŸ¦… Enable PriceHawk Alerts</span></a>
    {% else %}
      <div class="nav-item alert-on"><span>âœ… PriceHawk Alerts Active</span></div>
    {% endif %}
    <a href="{{ url_for('price_monitoring') }}" class="nav-item"><span>ðŸ“¡ Price monitoring</span></a>
    <div class="logout-nav">
      <form method="post" action="{{ url_for('logout') }}">
        <button type="submit" class="nav-item"><span>Logout</span></button>
      </form>
    </div>
  </div>

  <div class="main">
    <div class="mobile-only">
      <div class="mobile-header">
        <div>
          <h1>Tracker</h1>
          <div class="last-update"><span class="js-local-dt" data-utc="{{ last_run|replace(' ', 'T') }}Z">{{ last_run }}</span></div>
        </div>
        <div class="right">
          <form method="post" action="{{ url_for('logout') }}">
            <button class="top-btn" type="submit">Logout</button>
          </form>
        </div>
      </div>
    </div>

    {% if announcement %}
      <div class="banner announcement"><strong>Announcement:</strong> {{ announcement }}</div>
    {% endif %}

    {% with messages = get_flashed_messages(with_categories=true) %}
      {% if messages %}
        {% for cat,msg in messages %}
          <div class="banner">{{ msg }}</div>
        {% endfor %}
      {% endif %}
    {% endwith %}

    <div class="desktop-only">
      <section class="desktop-shell">
        <div class="desktop-topbar">
          <div class="desktop-title">
            <h1>Amazon.sa Price Tracker</h1>
            <div class="desktop-sub">Desktop dashboard with a shared chart, horizontal item slider, and live top deals.</div>
          </div>
          <div class="desktop-right">
            <div class="desktop-count">{{ items|length }} total items</div>
            <div class="desktop-time">Last update: <span class="js-local-dt" data-utc="{{ last_run|replace(' ', 'T') }}Z">{{ last_run }}</span></div>
            <form method="post" action="{{ url_for('logout') }}">
              <button class="orange-btn" type="submit">Logout</button>
            </form>
          </div>
        </div>

        <form method="post" action="{{ url_for('add') }}" class="desktop-add-form">
          <input name="item" class="desktop-search" placeholder="Add Product" required />
          <button class="orange-btn" type="submit">Add Product</button>
        </form>

        {% if items %}
          <div class="desktop-range">
            <div class="desktop-range-title">Primary range: 2W</div>
            <div class="range-tabs js-range-tabs">
              <button class="range-btn active" data-range="2w" type="button">2W</button>
              <button class="range-btn" data-range="1m" type="button">1M</button>
              <button class="range-btn" data-range="3m" type="button">3M</button>
              <button class="range-btn" data-range="6m" type="button">6M</button>
              <button class="range-btn" data-range="1y" type="button">1Y</button>
              <button class="range-btn" data-range="all" type="button">All</button>
            </div>
          </div>

          <div class="desktop-strip-wrap">
            <button class="slider-btn left" id="desktop-slide-left" type="button">&#8249;</button>
            <div class="desktop-strip" id="desktop-item-strip">
              {% for it in items %}
                <article class="desktop-item-card{% if loop.first %} active{% endif %}" data-item-id="{{ it.id }}" data-item-title="{{ it.latest_name if it.latest_name else it.asin }}" data-item-url="{{ it.url if it.url else ('https://www.amazon.sa/dp/' ~ it.asin ~ '?language=en') }}" data-item-seller="{{ it.latest_seller if it.latest_seller else '' }}">
                  <a
                    class="desktop-item-title"
                    href="{{ it.url if it.url else ('https://www.amazon.sa/dp/' ~ it.asin ~ '?language=en') }}"
                    target="_blank"
                    rel="noopener"
                    title="{{ it.latest_name if it.latest_name else it.asin }}"
                  >{{ it.latest_name if it.latest_name else it.asin }}</a>
                  <div class="desktop-seller">{% if it.latest_seller %}Seller: {{ it.latest_seller }}{% elif it.is_syncing %}Fetching latest data in the background...{% endif %}</div>
                  <div class="desktop-pills">
                    <div class="desktop-pill" id="dcur-{{ it.id }}">{{ it.latest_price_text if it.latest_price_text else '--' }}</div>
                    <div class="desktop-pill low" id="dl-{{ it.id }}">L: --</div>
                    <div class="desktop-pill high" id="dh-{{ it.id }}">H: --</div>
                  </div>
                  <form method="post" action="/set-target/{{ it.id }}" class="desktop-target-row">
                    <div class="desktop-target-box">
                      <label for="desktop-target-{{ it.id }}">Target price</label>
                      <input id="desktop-target-{{ it.id }}" name="target" class="desktop-target-input" inputmode="decimal" placeholder="{{ ('%.2f'|format(it.target_price_value|float)) if it.target_price_value is not none else '' }}">
                    </div>
                    <button class="desktop-set-btn" type="submit">Set</button>
                  </form>
                  <div class="desktop-action-row">
                    <form method="post" action="{{ url_for('delete_item', item_id=it.id) }}" onsubmit="return confirm('Delete item?')">
                      <button class="desktop-action-btn" type="submit">Delete item</button>
                    </form>
                    <button class="desktop-action-btn desktop-chart-trigger" type="button" data-chart-item="{{ it.id }}">Chart</button>
                  </div>
                </article>
              {% endfor %}
            </div>
            <button class="slider-btn right" id="desktop-slide-right" type="button">&#8250;</button>
          </div>

          <div class="desktop-main-grid">
            <section class="desktop-chart-panel">
              <div class="desktop-chart-head">
                <div class="desktop-chart-title">
                  {% set first_item = items[0] %}
                  <a id="desktop-selected-link" href="{{ first_item.url if first_item.url else ('https://www.amazon.sa/dp/' ~ first_item.asin ~ '?language=en') }}" target="_blank" rel="noopener">{{ first_item.latest_name if first_item.latest_name else first_item.asin }}</a>
                  <div class="desktop-chart-seller" id="desktop-selected-seller">{% if first_item.latest_seller %}Seller: {{ first_item.latest_seller }}{% endif %}</div>
                </div>
              </div>
              <div class="desktop-chart-stats">
                <div class="desktop-stat" id="cur-desktop">{{ first_item.latest_price_text if first_item.latest_price_text else '--' }}</div>
                <div class="desktop-stat low" id="l-desktop">L: --</div>
                <div class="desktop-stat high" id="h-desktop">H: --</div>
              </div>
              <div class="desktop-canvas-wrap">
                <canvas id="desktop-chart"></canvas>
                <div id="date-desktop" class="desktop-chart-date"></div>
              </div>
            </section>

            <aside class="desktop-deals-panel">
              <div>
                <h3>Top deals</h3>
                <p>Five rotating deals change on refresh or when you log in again.</p>
              </div>
              <div class="desktop-deals-list">
                {% for deal in marketing_deals[:5] %}
                  <div class="desktop-deal">
                    <div class="desktop-deal-title">{{ deal.title }}</div>
                    <div class="desktop-deal-meta">
                      <span>{{ deal.price_text }}</span>
                      <span class="desktop-badge">-{{ deal.best_percent }}%</span>
                    </div>
                    <div class="desktop-deal-actions">
                      <button class="desktop-action-btn" type="button" onclick="quickAddAsin('{{ deal.asin }}')">Add</button>
                    </div>
                  </div>
                {% else %}
                  <div class="desktop-deal">
                    <div class="desktop-deal-title">No rotating deals yet</div>
                  </div>
                {% endfor %}
              </div>
            </aside>
          </div>
        {% else %}
          <div class="desktop-empty">
            <h2 style="margin:0 0 8px 0; color:#fff;">No items yet</h2>
            <p style="margin:0;">Use Add Product above to start tracking your first item.</p>
          </div>
        {% endif %}
      </section>
    </div>

    <div class="mobile-only">
      {% if not user.get('telegram_chat_id') %}
        <div class="add-panel" style="background: linear-gradient(135deg, rgba(46, 229, 157, 0.15), rgba(46, 229, 157, 0.05)); border-color: rgba(46, 229, 157, 0.3);">
          <div style="display:flex; align-items:center; gap:15px;">
            <div style="flex:1;">
              <div style="font-weight:800; font-size:1.1rem; margin-bottom:5px; color:#2ee59d;">ðŸ¦… Enable PriceHawk Alerts</div>
              <div style="color:rgba(255,255,255,0.75); font-size:0.9rem;">Get instant Telegram notifications when prices drop to your target</div>
            </div>
            <a href="{{ url_for('telegram_setup') }}" class="btn-glow" style="white-space:nowrap;">Connect Telegram</a>
          </div>
        </div>
      {% else %}
        <div class="add-panel" style="background: linear-gradient(135deg, rgba(46, 229, 157, 0.15), rgba(46, 229, 157, 0.05)); border-color: rgba(46, 229, 157, 0.3);">
          <div style="display:flex; align-items:center; gap:15px;">
            <div style="flex:1;">
              <div style="font-weight:800; font-size:1.1rem; margin-bottom:5px; color:#2ee59d;">âœ… PriceHawk Alerts Active</div>
              <div style="color:rgba(255,255,255,0.75); font-size:0.9rem;">You'll receive urgent alerts on Telegram when prices drop</div>
            </div>
            <form method="post" action="{{ url_for('telegram_disconnect') }}">
              <button class="btn-outline" type="submit">Disconnect</button>
            </form>
          </div>
        </div>
      {% endif %}

      <div class="add-panel" style="background: linear-gradient(135deg, rgba(218, 174, 81, 0.14), rgba(213, 51, 105, 0.06)); border-color: rgba(218, 174, 81, 0.28);">
        <div style="display:flex; align-items:center; gap:15px; width:100%;">
          <div style="flex:1;">
            <div style="font-weight:900; font-size:1.05rem; margin-bottom:5px;">ðŸ“¡ Price monitoring</div>
            <div style="color:rgba(255,255,255,0.75); font-size:0.9rem;">Track your target prices and see when they hit.</div>
          </div>
          <a href="{{ url_for('price_monitoring') }}" class="btn-glow" style="white-space:nowrap;">Open</a>
        </div>
      </div>

      <div class="add-panel">
        <form method="post" action="{{ url_for('add') }}" style="display:flex; width:100%; gap:15px; align-items:center; flex-wrap:wrap;">
          <input name="item" class="search-input" placeholder="Paste Amazon.sa link or ASIN..." required />
          <button class="btn-glow" type="submit">Add</button>
        </form>
      </div>

      {% if items %}
        <div class="range-panel">
          <div class="range-title">Chart range</div>
          <div class="range-tabs js-range-tabs">
            <button class="range-btn active" data-range="2w" type="button">2W</button>
            <button class="range-btn" data-range="1m" type="button">1M</button>
            <button class="range-btn" data-range="3m" type="button">3M</button>
            <button class="range-btn" data-range="6m" type="button">6M</button>
            <button class="range-btn" data-range="1y" type="button">1Y</button>
            <button class="range-btn" data-range="all" type="button">All</button>
          </div>
        </div>
      {% endif %}

      {% if not items %}
        <div style="text-align:center; padding:50px; color:var(--text-muted);">
          <h2 style="margin:0 0 8px 0;">No items yet</h2>
          <p style="margin:0;">Use the bar above to add your first product.</p>
        </div>
      {% else %}
        <div class="grid">
          <div class="card">
            <div class="marketing-head">
              <h2>Top deals right now</h2>
            </div>
            <div class="marketing-list">
              {% for deal in marketing_deals[:5] %}
                <div class="deal-banner">
                  <div class="deal-top">
                    <div class="deal-title">{{ deal.title }}</div>
                  </div>
                  <div class="deal-body">
                    <div class="deal-price">{{ deal.price_text }}</div>
                    <div class="deal-mid">
                      <div class="deal-divider"></div>
                      <div class="deal-off">-{{ deal.best_percent }}%</div>
                      <button class="deal-add-btn" type="button" onclick="quickAddAsin('{{ deal.asin }}')">ADD</button>
                    </div>
                  </div>
                </div>
              {% endfor %}
            </div>
          </div>

          {% for it in items %}
            <div class="card">
              <div class="card-head">
                <div class="title-wrap">
                  <div class="item-title" title="{{ it.latest_name if it.latest_name else it.asin }}">
                    <a class="item-title-link" href="{{ it.url if it.url else ('https://www.amazon.sa/dp/' ~ it.asin ~ '?language=en') }}" target="_blank" rel="noopener">{{ it.latest_name if it.latest_name else it.asin }}</a>
                  </div>
                  {% if it.latest_rating or it.latest_review_count %}
                    <div class="seller-line">
                      {% if it.latest_rating %}Rating: {{ it.latest_rating }}/5{% endif %}
                      {% if it.latest_rating and it.latest_review_count %} | {% endif %}
                      {% if it.latest_review_count %}Votes: {{ it.latest_review_count }}{% endif %}
                    </div>
                  {% endif %}
                  {% if it.latest_seller %}
                    <div class="seller-line">Seller: {{ it.latest_seller }}</div>
                  {% endif %}
                  {% if it.is_syncing %}
                    <div class="seller-line" style="color:rgba(255,255,255,0.6);">Fetching latest data in the background...</div>
                  {% endif %}
                  <div class="meta-row">
                    <div class="pills">
                      <div class="pill"><strong id="cur-{{ it.id }}">{{ it.latest_price_text if it.latest_price_text else '--' }}</strong></div>
                      <div class="pill pill-low"><strong id="l-{{ it.id }}">L: --</strong></div>
                      <div class="pill pill-high"><strong id="h-{{ it.id }}">H: --</strong></div>
                      {% if it.coupon_text %}
                        <span class="pill pill-coupon" id="coupon-pct-{{ it.id }}">--</span>
                      {% endif %}
                    </div>
                  </div>
                  {% if it.coupon_text %}
                    <div class="coupon-expand" id="coupon-full-{{ it.id }}">{{ it.coupon_text }}</div>
                  {% endif %}
                </div>
              </div>

              <div class="chart-box">
                <canvas id="chart-{{ it.id }}"></canvas>
                <div id="info-{{ it.id }}" class="chart-info"></div>
                <div id="date-{{ it.id }}" class="chart-date"></div>
              </div>

              <div class="actions-row">
                <form method="post" action="/set-target/{{ it.id }}" class="target-box">
                  <label class="target-label">Target price:</label>
                  <input name="target" class="target-input" inputmode="decimal" placeholder="{{ ('%.2f'|format(it.target_price_value|float)) if it.target_price_value is not none else '' }}" />
                  <button class="target-submit-btn" type="submit">Set</button>
                </form>
                <form method="post" action="{{ url_for('delete_item', item_id=it.id) }}" class="delete-form" onsubmit="return confirm('Delete item?')">
                  <button class="del-btn" type="submit">Delete item</button>
                </form>
              </div>
            </div>
          {% endfor %}
        </div>
      {% endif %}
    </div>
  </div>

<script>
  Chart.defaults.color = 'rgba(255,255,255,0.70)';
  Chart.defaults.borderColor = 'rgba(255,255,255,0.06)';

  const parseTsUTC = (ts) => new Date(String(ts || "").replace(" ", "T") + "Z");
  const chartInstances = new Map();
  const historyCache = new Map();
  const itemIds = {{ items|map(attribute="id")|list|tojson }};
  let currentRange = '2w';
  let selectedDesktopItemId = itemIds.length ? Number(itemIds[0]) : null;

  async function loadHistory(itemId) {
    const r = await fetch(`/history/item/${itemId}.json?t=${new Date().getTime()}`);
    return await r.json();
  }

  function quickAddAsin(asin){
    const form = document.createElement('form');
    form.method = 'POST';
    form.action = "{{ url_for('add') }}";
    form.style.display = 'none';
    const inp = document.createElement('input');
    inp.name = 'item';
    inp.value = asin;
    form.appendChild(inp);
    document.body.appendChild(form);
    form.submit();
  }

  function localizeDateTimes(){
    document.querySelectorAll('.js-local-dt').forEach(el => {
      const v = el.getAttribute('data-utc') || '';
      const dt = new Date(v);
      if (isNaN(dt.getTime())) return;
      el.textContent = dt.toLocaleString();
    });
  }

  function fmtSAR(n) {
    if (n === null || n === undefined || isNaN(n)) return '--';
    return 'SAR ' + Number(n).toFixed(2);
  }

  function getRangeStart(now, rangeKey){
    const dt = new Date(now.getTime());
    if (rangeKey === '2w') dt.setDate(dt.getDate() - 14);
    else if (rangeKey === '1m') dt.setMonth(dt.getMonth() - 1);
    else if (rangeKey === '3m') dt.setMonth(dt.getMonth() - 3);
    else if (rangeKey === '6m') dt.setMonth(dt.getMonth() - 6);
    else if (rangeKey === '1y') dt.setFullYear(dt.getFullYear() - 1);
    else return null;
    return dt;
  }

  function buildSummary(points) {
    const source = (points || []).filter(p => Number(p.price_value) > 0);
    if (!source.length) {
      return {
        hasNumeric: false,
        currentText: 'No numeric price yet',
        lowText: 'L: --',
        highText: 'H: --',
        raw: []
      };
    }
    const vals = source.map(p => Number(p.price_value)).filter(v => !isNaN(v) && v > 0);
    const current = vals[vals.length - 1];
    const minV = Math.min(...vals);
    const maxV = Math.max(...vals);
    const noChange = Math.abs(maxV - minV) < 0.005;
    return {
      hasNumeric: true,
      currentText: fmtSAR(current),
      lowText: noChange ? 'L: --' : `L: ${fmtSAR(minV).replace('SAR ', '')}`,
      highText: noChange ? 'H: --' : `H: ${fmtSAR(maxV).replace('SAR ', '')}`,
      raw: source,
      minV,
      maxV
    };
  }

  function setText(id, value) {
    const el = document.getElementById(id);
    if (el) el.textContent = value;
  }

  function applySummaryToItem(itemId, summary) {
    setText(`cur-${itemId}`, summary.currentText);
    setText(`l-${itemId}`, summary.lowText);
    setText(`h-${itemId}`, summary.highText);
    setText(`dcur-${itemId}`, summary.currentText);
    setText(`dl-${itemId}`, summary.lowText);
    setText(`dh-${itemId}`, summary.highText);
  }

  function applySummaryToDesktop(summary) {
    setText('cur-desktop', summary.currentText);
    setText('l-desktop', summary.lowText);
    setText('h-desktop', summary.highText);
  }

  function buildChart(canvasId, dateElId, points, rangeKey = '2w') {
    const canvas = document.getElementById(canvasId);
    if (!canvas) return buildSummary(points);

    const previous = chartInstances.get(canvasId);
    if (previous) {
      try { previous.destroy(); } catch (_) {}
      chartInstances.delete(canvasId);
    }

    const ctx = canvas.getContext('2d');
    const dateEl = document.getElementById(dateElId);
    const summary = buildSummary(points);

    if (!summary.hasNumeric) {
      if (dateEl) dateEl.textContent = 'No numeric price yet';
      return summary;
    }

    const now = new Date();
    const rangeStart = getRangeStart(now, rangeKey);
    let raw = summary.raw;
    if (rangeStart) {
      raw = raw.filter(p => {
        const dt = parseTsUTC(p.ts);
        return !isNaN(dt.getTime()) && dt >= rangeStart;
      });
      if (!raw.length && summary.raw.length) raw = [summary.raw[summary.raw.length - 1]];
    }

    function downsampleHourly(arr){
      const out = [];
      let lastT = null;
      for (const p of (arr || [])) {
        const dt = parseTsUTC(p.ts);
        if (isNaN(dt.getTime())) continue;
        if (!lastT || (dt - lastT) >= 60 * 60 * 1000) {
          out.push(p);
          lastT = dt;
        }
      }
      return out;
    }

    const sampled = downsampleHourly(raw);
    const lastPoint = (sampled.length ? sampled[sampled.length - 1] : raw[raw.length - 1]);
    const lastDate = parseTsUTC(lastPoint.ts);
    let dataPoints = (sampled.length ? sampled : raw).slice();

    if (raw.length === 1) {
      const only = raw[0];
      const onlyDate = parseTsUTC(only.ts);
      const left = new Date((isNaN(onlyDate.getTime()) ? now : onlyDate).getTime() - 60 * 60 * 1000);
      dataPoints = [
        { ts: left.toISOString().replace('T', ' ').substring(0, 19), price_value: only.price_value },
        only,
        { ts: now.toISOString().replace('T', ' ').substring(0, 19), price_value: only.price_value }
      ];
    } else if (!isNaN(lastDate.getTime()) && (now - lastDate) > 1000 * 60 * 60 * 2) {
      dataPoints.push({
        ts: now.toISOString().replace('T', ' ').substring(0, 19),
        price_value: lastPoint.price_value
      });
    }

    const labels = dataPoints.map(p => p.ts);
    const prices = dataPoints.map(p => p.price_value);
    const parsedLabels = labels.map((ts, idx) => {
      const dt = parseTsUTC(ts);
      if (isNaN(dt.getTime())) return { idx, dt: null, dayKey: '', monthKey: '' };
      const dayKey = dt.getFullYear() + '-' + String(dt.getMonth() + 1).padStart(2, '0') + '-' + String(dt.getDate()).padStart(2, '0');
      const monthKey = dt.getFullYear() + '-' + String(dt.getMonth() + 1).padStart(2, '0');
      return { idx, dt, dayKey, monthKey };
    });

    const validPoints = parsedLabels.filter(p => p.dt);
    const boundaryCandidates = [];
    let prevMonth = null;
    for (const p of validPoints) {
      if (p.monthKey !== prevMonth) {
        boundaryCandidates.push(p.idx);
        prevMonth = p.monthKey;
      }
    }

    function pickEvenly(arr, maxCount) {
      const uniq = [...new Set(arr)].sort((a, b) => a - b);
      if (uniq.length <= maxCount) return uniq;
      const out = [uniq[0]];
      const middleSlots = Math.max(0, maxCount - 2);
      for (let i = 1; i <= middleSlots; i++) {
        const pos = Math.round((i * (uniq.length - 1)) / (middleSlots + 1));
        out.push(uniq[pos]);
      }
      out.push(uniq[uniq.length - 1]);
      return [...new Set(out)].sort((a, b) => a - b);
    }

    const chosenTickIdx = new Set(pickEvenly(boundaryCandidates.length ? boundaryCandidates : [0, labels.length - 1], 6));
    chosenTickIdx.add(0);
    chosenTickIdx.add(labels.length - 1);

    const tickLabelMap = new Map();
    for (const idx of chosenTickIdx) {
      const p = parsedLabels[idx];
      if (!p || !p.dt) continue;
      tickLabelMap.set(idx, p.dt.toLocaleDateString([], { month: 'short' }));
    }

    const dayBoundaryIdx = [];
    let prevDay = null;
    for (const p of parsedLabels) {
      if (!p.dt) continue;
      if (prevDay !== null && p.dayKey !== prevDay) {
        dayBoundaryIdx.push(p.idx);
      }
      prevDay = p.dayKey;
    }

    const fmtHoverDate = (idx) => {
      const safeIdx = Math.max(0, Math.min(labels.length - 1, idx));
      const dt = parseTsUTC(labels[safeIdx]);
      if (isNaN(dt.getTime())) return '';
      return dt.toLocaleDateString([], { month: 'short', day: 'numeric' });
    };

    if (dateEl) dateEl.textContent = fmtHoverDate(labels.length - 1);

    let suggestedMin = undefined;
    let suggestedMax = undefined;
    if (summary.minV !== undefined && summary.maxV !== undefined) {
      const span = Math.max(0, summary.maxV - summary.minV);
      const pad = Math.max(1, span * 0.20, summary.maxV * 0.02);
      suggestedMin = Math.max(0, summary.minV - pad);
      suggestedMax = summary.maxV + pad;
    }

    const gradient = ctx.createLinearGradient(0, 0, 0, 240);
    gradient.addColorStop(0, 'rgba(218, 174, 81, 0.28)');
    gradient.addColorStop(1, 'rgba(218, 174, 81, 0.00)');

    const dividerPlugin = {
      id: 'dayDividers',
      beforeDatasetsDraw: (chart) => {
        const xScale = chart.scales.x;
        const yScale = chart.scales.y;
        const c = chart.ctx;
        c.save();
        c.strokeStyle = 'rgba(255,255,255,0.05)';
        c.lineWidth = 1;
        dayBoundaryIdx.forEach(idx => {
          const x = xScale.getPixelForValue(idx);
          c.beginPath();
          c.moveTo(x, yScale.top);
          c.lineTo(x, yScale.bottom);
          c.stroke();
        });
        c.restore();
      }
    };

    const crosshairPlugin = {
      id: 'crosshair',
      afterDraw: (chart) => {
        if (!chart.tooltip?._active?.length) return;
        const x = chart.tooltip._active[0].element.x;
        const yAxis = chart.scales.y;
        const c = chart.ctx;
        c.save();
        c.beginPath();
        c.moveTo(x, yAxis.top);
        c.lineTo(x, yAxis.bottom);
        c.lineWidth = 1;
        c.strokeStyle = 'rgba(218,174,81,0.45)';
        c.stroke();
        c.restore();
      }
    };

    const chart = new Chart(ctx, {
      type: 'line',
      data: {
        labels,
        datasets: [{
          data: prices,
          borderColor: 'rgba(218, 174, 81, 0.95)',
          backgroundColor: gradient,
          fill: true,
          borderWidth: 2.6,
          pointRadius: 0,
          tension: 0
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        interaction: { mode: 'index', intersect: false },
        plugins: {
          legend: { display: false },
          tooltip: {
            intersect: false,
            mode: 'index',
            displayColors: false,
            backgroundColor: 'rgba(15, 12, 41, 0.92)',
            borderColor: 'rgba(218, 174, 81, 0.30)',
            borderWidth: 1,
            titleColor: 'rgba(255,255,255,0.92)',
            bodyColor: 'rgba(255,255,255,0.92)',
            padding: 10,
            callbacks: {
              label: (ctx) => {
                const dt = parseTsUTC(ctx.label);
                const hhmm = (!isNaN(dt.getTime()))
                  ? dt.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })
                  : '';
                return ctx.parsed.y.toFixed(2) + (hhmm ? ('  ' + hhmm) : '');
              },
              title: (items) => {
                if (!items?.length) return '';
                const idx = Number(items[0].dataIndex || 0);
                if (dateEl) dateEl.textContent = fmtHoverDate(idx);
                return '';
              }
            }
          }
        },
        onHover: (event, elements, chart) => {
          if (!dateEl) return;
          const hoverElements = (chart && typeof chart.getElementsAtEventForMode === 'function')
            ? chart.getElementsAtEventForMode(event, 'index', { intersect: false }, false)
            : elements;
          if (hoverElements && hoverElements.length) {
            dateEl.textContent = fmtHoverDate(Number(hoverElements[0].index || 0));
          } else {
            dateEl.textContent = fmtHoverDate(labels.length - 1);
          }
        },
        scales: {
          x: {
            display: true,
            grid: { display: false },
            ticks: {
              autoSkip: false,
              maxRotation: 0,
              minRotation: 0,
              padding: 4,
              font: { size: 10 },
              callback: function(value) {
                const idx = Number(value);
                if (!Number.isFinite(idx) || idx < 0 || idx >= labels.length) return '';
                return tickLabelMap.get(idx) || '';
              }
            }
          },
          y: {
            suggestedMin,
            suggestedMax,
            ticks: { callback: (v) => v.toFixed(0), maxTicksLimit: 6 },
            grid: { color: 'rgba(255,255,255,0.06)' }
          }
        }
      },
      plugins: [dividerPlugin, crosshairPlugin]
    });

    chartInstances.set(canvasId, chart);
    return summary;
  }

  function updateDesktopSelectionMeta(itemId) {
    const card = document.querySelector(`.desktop-item-card[data-item-id="${itemId}"]`);
    if (!card) return;
    document.querySelectorAll('.desktop-item-card').forEach(node => {
      node.classList.toggle('active', Number(node.getAttribute('data-item-id')) === Number(itemId));
    });
    const title = card.getAttribute('data-item-title') || '';
    const seller = card.getAttribute('data-item-seller') || '';
    const url = card.getAttribute('data-item-url') || '#';
    const linkEl = document.getElementById('desktop-selected-link');
    const sellerEl = document.getElementById('desktop-selected-seller');
    if (linkEl) {
      linkEl.textContent = title || 'Tracked item';
      linkEl.href = url;
    }
    if (sellerEl) {
      sellerEl.textContent = seller ? `Seller: ${seller}` : '';
    }
  }

  async function renderDesktopChart(itemId) {
    if (!itemId) return;
    selectedDesktopItemId = Number(itemId);
    updateDesktopSelectionMeta(itemId);
    let points = historyCache.get(Number(itemId));
    if (!points) {
      points = await loadHistory(Number(itemId));
      historyCache.set(Number(itemId), points);
    }
    const summary = buildChart('desktop-chart', 'date-desktop', points, currentRange);
    applySummaryToDesktop(summary);
  }

  async function primeAllItemSummaries() {
    for (const itemId of itemIds) {
      try {
        let points = historyCache.get(itemId);
        if (!points) {
          points = await loadHistory(itemId);
          historyCache.set(itemId, points);
        }
        const summary = buildSummary(points);
        applySummaryToItem(itemId, summary);
      } catch (e) {
        console.error(e);
      }
    }
  }

  async function renderMobileCharts() {
    for (const itemId of itemIds) {
      try {
        let points = historyCache.get(itemId);
        if (!points) {
          points = await loadHistory(itemId);
          historyCache.set(itemId, points);
        }
        const summary = buildChart(`chart-${itemId}`, `date-${itemId}`, points, currentRange);
        applySummaryToItem(itemId, summary);
      } catch (e) {
        console.error(e);
      }
    }
  }

  function initCoupons(){
    const nodes = document.querySelectorAll('[id^="coupon-full-"]');
    nodes.forEach(fullEl => {
      const asin = fullEl.id.replace('coupon-full-','');
      const pctEl = document.getElementById('coupon-pct-' + asin);
      if (!pctEl) return;
      const txt = (fullEl.textContent || '').trim();
      const nums = (txt.match(/\d{1,3}\s*%/g) || [])
        .map(s => parseInt(s.replace('%','').trim(), 10))
        .filter(n => n >= 1 && n <= 95);
      const uniq = Array.from(new Set(nums)).sort((a, b) => a - b);
      if (!uniq.length) {
        pctEl.style.display = 'none';
        fullEl.style.display = 'none';
        return;
      }
      pctEl.textContent = uniq.map(n => `%${n}`).join(' | ');
      const stripped = txt.replace(/\d{1,3}\s*%/g, '').replace(/[|,\-]/g, '').trim();
      if (!stripped) {
        fullEl.textContent = '';
        fullEl.style.display = 'none';
      }
    });
  }

  function initRangeTabs() {
    const wrappers = Array.from(document.querySelectorAll('.js-range-tabs'));
    if (!wrappers.length) return;
    const buttons = wrappers.flatMap(wrap => Array.from(wrap.querySelectorAll('.range-btn')));
    const syncButtons = () => {
      buttons.forEach(btn => {
        btn.classList.toggle('active', btn.getAttribute('data-range') === currentRange);
      });
    };
    buttons.forEach(btn => {
      btn.addEventListener('click', async () => {
        const range = btn.getAttribute('data-range') || 'all';
        if (range === currentRange) return;
        currentRange = range;
        syncButtons();
        if (window.matchMedia('(max-width: 900px)').matches) {
          await renderMobileCharts();
        } else {
          await renderDesktopChart(selectedDesktopItemId);
        }
      });
    });
    syncButtons();
  }

  function initDesktopSlider() {
    const strip = document.getElementById('desktop-item-strip');
    const left = document.getElementById('desktop-slide-left');
    const right = document.getElementById('desktop-slide-right');
    if (!strip || !left || !right) return;

    const updateButtons = () => {
      const maxScroll = Math.max(0, strip.scrollWidth - strip.clientWidth);
      left.disabled = strip.scrollLeft <= 4;
      right.disabled = strip.scrollLeft >= (maxScroll - 4);
      const shouldHide = maxScroll <= 4;
      left.style.display = shouldHide ? 'none' : '';
      right.style.display = shouldHide ? 'none' : '';
    };

    const scrollByCards = (dir) => {
      const amount = Math.max(260, Math.round(strip.clientWidth * 0.85));
      strip.scrollBy({ left: dir * amount, behavior: 'smooth' });
      setTimeout(updateButtons, 220);
    };

    left.addEventListener('click', () => scrollByCards(-1));
    right.addEventListener('click', () => scrollByCards(1));
    strip.addEventListener('scroll', updateButtons, { passive: true });
    window.addEventListener('resize', updateButtons);
    updateButtons();
  }

  function initDesktopCardActions() {
    document.querySelectorAll('.desktop-chart-trigger').forEach(btn => {
      btn.addEventListener('click', async () => {
        const itemId = Number(btn.getAttribute('data-chart-item'));
        if (!itemId) return;
        await renderDesktopChart(itemId);
      });
    });
  }

  (async () => {
    localizeDateTimes();
    initCoupons();
    initRangeTabs();
    if (window.matchMedia('(max-width: 900px)').matches) {
      await renderMobileCharts();
    } else {
      await primeAllItemSummaries();
      initDesktopSlider();
      initDesktopCardActions();
      if (selectedDesktopItemId) {
        await renderDesktopChart(selectedDesktopItemId);
      }
    }
  })();
</script>

</body>
</html>
