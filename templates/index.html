<!-- ... (Keep Header/Styles from previous index.html) ... -->

<!-- INSIDE THE CARD, BELOW CANVAS -->
<div class="chart-box">
    <canvas id="chart-{{ it.asin }}"></canvas>
</div>
<!-- NEW: Data Footer -->
<div id="info-{{ it.asin }}" style="font-size:0.85em; color:#daae51; text-align:center; height:20px; margin-top:5px;"></div>

<!-- ... (Rest of HTML) ... -->

<script>
// Chart Config
Chart.defaults.color = '#8b8b9e';
Chart.defaults.borderColor = 'rgba(255,255,255,0.05)';

async function loadHistory(asin) {
  const r = await fetch(`/history/${asin}.json`);
  return await r.json();
}

function buildChart(canvasId, points, asin) {
  const ctx = document.getElementById(canvasId).getContext('2d');
  const infoDiv = document.getElementById('info-' + asin);
  
  const validPoints = points.filter(p => p.price_value > 0);
  if (validPoints.length === 0) return;

  const labels = validPoints.map(p => p.ts);
  const prices = validPoints.map(p => p.price_value);

  // Gradient
  const gradient = ctx.createLinearGradient(0, 0, 0, 400);
  gradient.addColorStop(0, 'rgba(213, 51, 105, 0.5)'); 
  gradient.addColorStop(1, 'rgba(213, 51, 105, 0)');   

  new Chart(ctx, {
    type: 'line',
    data: {
      labels: labels,
      datasets: [{
        data: prices,
        stepped: 'before',
        borderColor: '#d53369',
        backgroundColor: gradient,
        borderWidth: 2,
        pointRadius: 0,
        pointHoverRadius: 6,
        pointBackgroundColor: '#fff',
        fill: true,
        spanGaps: true
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      interaction: {
        mode: 'index',
        intersect: false,
      },
      plugins: {
        legend: { display: false },
        tooltip: {
            enabled: false, // Disable default tooltip
            external: function(context) {
                // Custom Logic to update the Div below chart
                const tooltip = context.tooltip;
                if (tooltip.opacity === 0) {
                    infoDiv.innerText = "";
                    return;
                }
                const dateStr = tooltip.dataPoints[0].label; // Full timestamp
                const price = tooltip.dataPoints[0].raw;
                // Format Date nicely
                const d = new Date(dateStr);
                const dateFmt = d.toLocaleDateString('en-GB', { day: 'numeric', month: 'short' });
                const timeFmt = d.toLocaleTimeString('en-GB', { hour: '2-digit', minute:'2-digit' });
                
                infoDiv.innerText = `${dateFmt} ${timeFmt} â€¢ SAR ${price}`;
            }
        },
        // Draw vertical crosshair line
        annotation: {
            // Requires plugin, but basic interaction works without it via hover
        }
      },
      scales: {
        x: { display: false }, // Hide Dates
        y: { display: false }  // Hide Prices
      }
    }
  });
}

(async () => {
  const asins = {{ items|map(attribute="asin")|list|tojson }};
  for (const asin of asins) {
    try {
      const points = await loadHistory(asin);
      buildChart(`chart-${asin}`, points, asin);
    } catch (e) { console.error(e); }
  }
})();
</script>