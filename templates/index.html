<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Amazon.sa Tracker</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; margin: 0; background: #f5f7fa; color: #333; }
    .topbar { background: #232f3e; color: #fff; padding: 12px 24px; display: flex; align-items: center; justify-content: space-between; flex-wrap: wrap; gap: 10px; }
    .topbar a { color: #ddd; text-decoration: none; margin-right: 15px; font-size: 0.9em; }
    .status-badge { font-size: 0.85em; background: #37475a; padding: 4px 10px; border-radius: 4px; }
    .container { max-width: 98%; margin: 24px auto; padding: 0 10px; }
    .panel { background: #fff; border-radius: 8px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); padding: 20px; margin-bottom: 24px; }
    .msg { padding: 12px; border-radius: 6px; margin: 10px 0; font-size: 0.95em; }
    .ok { background: #e6fffa; border: 1px solid #b2f5ea; color: #2c7a7b; }
    .error { background: #fff5f5; border: 1px solid #feb2b2; color: #c53030; }
    
    .add-row { display: flex; gap: 10px; max-width: 600px; width: 100%; }
    .add-row input { flex: 1; padding: 10px 14px; border: 1px solid #cbd5e0; border-radius: 6px; outline: none; }
    .btn { padding: 10px 18px; border: 0; border-radius: 6px; background: #232f3e; color: #fff; font-weight: 600; cursor: pointer; }
    .btn2 { padding: 8px 14px; border: 1px solid #cbd5e0; border-radius: 6px; background: #fff; color: #4a5568; font-weight: 600; cursor: pointer; }
    .btn-del { color: #e53e3e; border-color: #feb2b2; }

    .charts-row { display: grid; grid-template-columns: repeat(auto-fill, minmax(350px, 1fr)); gap: 16px; }
    .card { background: #fff; border-radius: 8px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); padding: 16px; display: flex; flex-direction: column; }
    .title-area { margin-bottom: 8px; min-height: 44px; }
    .title-text { font-weight: 700; font-size: 0.95em; color: #2d3748; display: block; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
    .title-text.expanded { white-space: normal; }
    .more-link { font-size: 0.8em; color: #3182ce; cursor: pointer; background: none; border: none; padding: 0; text-decoration: underline; }
    .price-tag { font-size: 1.1em; font-weight: 800; color: #1a202c; }
    .discount-badge { background: #c53030; color: #fff; padding: 2px 6px; border-radius: 4px; font-size: 0.75em; font-weight: bold; margin-left: 6px; }
    .meta { font-size: 0.8em; color: #718096; margin-top: 4px; }
    
    .chart-container { position: relative; height: 250px; width: 100%; margin-top: 15px; }
    .card-actions { margin-top: auto; padding-top: 12px; display: flex; justify-content: space-between; border-top: 1px solid #edf2f7; }
  </style>
</head>
<body>
  <div class="topbar">
    <div style="display:flex; align-items:center; gap:10px;">
      <strong>Amazon.sa Tracker</strong>
      <span class="status-badge">Last Update: {{ last_global_update }}</span>
    </div>
    <div style="display:flex; align-items:center; gap:10px;">
      <span style="opacity:.6; font-size: 0.85em;">{{ user["email"] }}</span>
      {% if is_admin %}
        <a href="{{ url_for('admin_users') }}">Users</a>
      {% endif %}
      <form method="post" action="{{ url_for('logout') }}" style="display:inline">
        <button class="btn2" style="background:transparent; border-color:#4a5568; color:#fff;" type="submit">Logout</button>
      </form>
    </div>
  </div>

  <div class="container">
    {% with messages = get_flashed_messages(with_categories=true) %}
      {% if messages %}
        <div class="panel" style="padding:10px;">
          {% for cat,msg in messages %}
            <div class="msg {{cat}}">{{msg}}</div>
          {% endfor %}
        </div>
      {% endif %}
    {% endwith %}

    <div class="panel">
      <h3 style="margin:0 0 15px 0;">Add Item</h3>
      <form method="post" action="{{ url_for('add') }}" class="add-row">
        <input name="item" placeholder="Paste ASIN or Amazon.sa URL" required />
        <button class="btn" type="submit">Add</button>
      </form>
    </div>

    {% if not items %}
      <div class="panel" style="text-align:center; padding: 50px;">
        <p>No items yet. Paste an Amazon.sa URL above to get started.</p>
      </div>
    {% else %}
      <div class="charts-row">
        {% for it in items %}
          <div class="card">
            <div class="title-area">
              <a href="{{ it.url }}" target="_blank" class="title-text truncated" id="title-text-{{ it.asin }}" style="text-decoration:none;">
                {{ it.latest_name if it.latest_name else it.asin }}
              </a>
              <button class="more-link" onclick="toggleTitle('{{ it.asin }}', this)">More</button>
            </div>
            <div>
              <span class="price-tag">{{ it.latest_price_text if it.latest_price_text else "Pending..." }}</span>
              {% if it.latest_discount is not none %}
                <span class="discount-badge">-{{ it.latest_discount }}%</span>
              {% endif %}
              <div class="meta">Last check: {{ it.latest_ts.split(' ')[1] if it.latest_ts else "-" }}</div>
            </div>
            
            <div class="chart-container">
                <canvas id="chart-{{ it.asin }}"></canvas>
            </div>

            <div class="card-actions">
              <form method="post" action="{{ url_for('update_one', asin=it.asin) }}">
                <button class="btn2" type="submit">Refresh</button>
              </form>
              <form method="post" action="{{ url_for('delete', asin=it.asin) }}" onsubmit="return confirm('Delete?');">
                <button class="btn2 btn-del" type="submit">Delete</button>
              </form>
            </div>
          </div>
        {% endfor %}
      </div>
    {% endif %}
  </div>

<script>
async function loadHistory(asin) {
  const r = await fetch(`/history/${asin}.json`);
  return await r.json();
}

function buildChart(canvasId, points) {
  const ctx = document.getElementById(canvasId).getContext('2d');
  
  // Strict check to remove zeros from the view
  const validPoints = points.filter(p => p.price_value > 0);
  if (validPoints.length === 0) return;

  const labels = validPoints.map(p => p.ts ? p.ts.substring(5, 16) : "");
  const prices = validPoints.map(p => p.price_value);

  // KEEPA STYLE: Stepped + Orange Fill
  new Chart(ctx, {
    type: 'line',
    data: {
      labels: labels,
      datasets: [{
        label: 'Price',
        data: prices,
        stepped: 'before', // This makes the lines jump vertically
        borderColor: '#FF9900', // Amazon Orange
        backgroundColor: 'rgba(255, 153, 0, 0.2)',
        borderWidth: 2,
        pointRadius: 0,
        pointHoverRadius: 6,
        fill: true,
        spanGaps: true
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      interaction: { mode: 'index', intersect: false },
      plugins: { legend: { display: false } },
      scales: {
        x: { display: false },
        y: { display: true, position: 'right', grid: { color: '#f5f5f5' } }
      }
    }
  });
}

(async () => {
  const asins = {{ items|map(attribute="asin")|list|tojson }};
  for (const asin of asins) {
    try {
      const points = await loadHistory(asin);
      buildChart(`chart-${asin}`, points);
    } catch (e) { console.error(e); }
  }
})();

function toggleTitle(asin, btn) {
    const el = document.getElementById('title-text-' + asin);
    if (el.classList.contains('expanded')) {
        el.classList.remove('expanded');
        btn.textContent = "More";
    } else {
        el.classList.add('expanded');
        btn.textContent = "Less";
    }
}
</script>
</body>
</html>
