<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Dashboard</title>

  <style>
    :root{
      --bg1:#0b0b13;
      --bg2:#17173a;
      --card:#121233cc;
      --card2:#0f0f2bd1;
      --stroke:#ffffff12;
      --text:#e9e9ff;
      --muted:#a9a9c9;
      --accent:#ff3a7a;
      --accent2:#9c27ff;
      --good:#00e676;
      --warn:#ffb300;

      /* Chart height (also used for 5 marketing banners total height) */
      --chart-h: 180px;
    }

    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      background: radial-gradient(1200px 600px at 70% 20%, #2b2b74 0%, transparent 60%),
                  radial-gradient(900px 500px at 30% 10%, #4c1d95 0%, transparent 55%),
                  linear-gradient(160deg,var(--bg1),var(--bg2));
      color:var(--text);
      min-height:100vh;
    }

    .layout{display:flex; min-height:100vh;}
    .sidebar{
      width:240px;
      padding:22px 18px;
      background: linear-gradient(180deg,#0a0a14, #0b0b21);
      border-right:1px solid var(--stroke);
    }
    .brand{font-weight:800; letter-spacing:.5px; margin-bottom:22px;}
    .nav a{
      display:block;
      padding:12px 14px;
      border-radius:14px;
      color:var(--text);
      text-decoration:none;
      background: transparent;
      border:1px solid transparent;
      margin-bottom:10px;
    }
    .nav a.active{
      background: #ffffff0f;
      border-color:#ffffff18;
      box-shadow: inset 0 0 0 1px #ffffff10;
      position:relative;
    }
    .nav a.active:before{
      content:"";
      position:absolute; left:-18px; top:0; bottom:0;
      width:4px; border-radius:4px;
      background: linear-gradient(180deg,#ffd54f,#ff8a00);
    }

    .content{
      flex:1;
      padding:26px 24px;
    }

    .topbar{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:16px;
      margin-bottom:16px;
    }
    h1{margin:0; font-size:34px; letter-spacing:.4px;}

    .search-wrap{
      margin:14px 0 20px;
      padding:18px;
      background: linear-gradient(180deg,#0f0f2fbb, #0f0f2b88);
      border:1px solid #ffffff18;
      border-radius:20px;
      box-shadow: 0 18px 40px #00000055;
    }
    .search-row{
      display:flex; gap:12px;
      align-items:center;
    }
    .search-input{
      flex:1;
      padding:14px 16px;
      border-radius:14px;
      outline:none;
      border:1px solid #ffffff1f;
      background:#0a0a19aa;
      color:var(--text);
      font-size:15px;
    }
    .btn-glow{
      padding:12px 18px;
      border:none;
      border-radius:14px;
      color:#fff;
      background: linear-gradient(135deg, var(--accent2), var(--accent));
      cursor:pointer;
      font-weight:700;
      box-shadow: 0 10px 24px #b026ff30;
    }

    .grid{
      display:grid;
      grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
      gap:18px;
      align-items:start;
    }

    .card{
      background: linear-gradient(180deg,var(--card),var(--card2));
      border:1px solid #ffffff18;
      border-radius:26px;
      box-shadow: 0 18px 40px #00000055;
      padding:16px 16px 14px;
      position:relative;
      overflow:hidden;
    }
    .card:after{
      content:"";
      position:absolute; inset:-1px;
      border-radius:26px;
      pointer-events:none;
      background: radial-gradient(800px 300px at 70% 0%, #ffffff10, transparent 60%);
    }

    .title{
      font-weight:900;
      font-size:22px;
      letter-spacing:.2px;
      margin:0 0 8px;
      line-height:1.2;
      text-shadow: 0 2px 10px #00000055;
    }

    .meta-row{
      display:flex;
      flex-wrap:wrap;
      gap:10px;
      align-items:center;
      margin-bottom:12px;
    }

    .price{
      font-weight:900;
      font-size:22px;
      color:#78ffb4;
      text-shadow: 0 2px 10px #00e67618;
    }

    .pill{
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding:7px 10px;
      border-radius:12px;
      border:1px solid #ffffff18;
      background:#00000022;
      font-weight:800;
      color:var(--text);
      font-size:14px;
      white-space:nowrap;
    }
    .pill.low{border-color:#ff98003b; color:#ffb74d;}
    .pill.high{border-color:#ff52523b; color:#ff8a80;}
    .pill.coupons{
      border-color:#00e6762b;
      background:#00e67610;
      color:#b8ffd7;
    }

    .chart-box{
      height:var(--chart-h);
      border-top:1px solid #ffffff10;
      padding-top:12px;
      margin-top:6px;
    }
    canvas{width:100% !important; height:100% !important;}

    .actions{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      padding-top:14px;
      border-top:1px solid #ffffff10;
      margin-top:12px;
    }

    .target-form{
      display:flex;
      gap:8px;
      align-items:center;
      flex:1;
    }
    .target-label{color:#e8ff5a; font-weight:800;}
    .target-input{
      width:120px;
      padding:10px 12px;
      border-radius:10px;
      border:1px solid #ffffff1c;
      background:#00000022;
      color:var(--text);
      outline:none;
    }
    .btn-save{
      padding:10px 12px;
      border-radius:10px;
      border:none;
      cursor:pointer;
      font-weight:800;
      background:#ffffff14;
      color:#fff;
      border:1px solid #ffffff1f;
    }
    .btn-del{
      color:#ff4d4d;
      font-weight:900;
      text-decoration:none;
      margin-left:10px;
    }

    /* -------- Marketing (5 banners total height = 1 chart height) -------- */
    .marketing-card{
      padding:14px 14px 14px;
    }
    .marketing-head{
      display:flex;
      align-items:center;
      justify-content:space-between;
      margin-bottom:10px;
    }
    .marketing-title{
      font-weight:900;
      font-size:18px;
      margin:0;
      letter-spacing:.2px;
    }
    .marketing-sub{
      font-size:12px;
      color:var(--muted);
      font-weight:700;
    }

    .marketing-list{
      display:flex;
      flex-direction:column;
      gap:8px;
      height:var(--chart-h);
      overflow:hidden;
    }

    .deal-banner{
      position:relative;
      flex:1;
      min-height:0;
      border-radius:18px;
      border:1px solid #ffffff1a;
      overflow:hidden;
      padding:8px 12px;

      /* YOUR PNG */
      background-image:url("{{ url_for('static', filename='banner.png') }}");
      background-size:cover;
      background-position:center;
      background-repeat:no-repeat;

      box-shadow: inset 0 0 0 1px #ffffff08, 0 10px 24px #00000033;
    }

    .deal-banner:before{
      content:"";
      position:absolute; inset:0;
      background: linear-gradient(90deg, #00000055 0%, transparent 55%);
      pointer-events:none;
    }

    .deal-content{
      position:relative;
      z-index:2;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      height:100%;
    }

    .deal-left{
      display:flex;
      flex-direction:column;
      gap:3px;
      min-width:0;
      flex:1;
    }

    .deal-name{
      font-weight:1000;
      font-size:13px;
      line-height:1.1;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
      text-shadow:0 2px 10px #00000066;
    }

    .deal-price{
      font-weight:1000;
      font-size:12px;
      color:#ffe39a;
      text-shadow:0 2px 10px #00000066;
    }

    .deal-right{
      display:flex;
      align-items:center;
      gap:8px;
      flex-shrink:0;
    }

    .deal-discount{
      font-weight:1000;
      font-size:16px;
      color:#fff;
      background: #ff8a001c;
      border:1px solid #ffb30055;
      padding:6px 10px;
      border-radius:14px;
      text-shadow:0 2px 10px #00000066;
      white-space:nowrap;
    }

    .deal-add-btn{
      border:none;
      cursor:pointer;
      font-weight:1000;
      color:#fff;
      background: linear-gradient(135deg, #ff8a00, #ff3d00);
      border-radius:14px;
      padding:8px 12px;
      box-shadow:0 10px 18px #ff3d0030;
      white-space:nowrap;
    }

    /* Hide meta (requested) */
    .deal-meta{display:none;}
  </style>
</head>

<body>
  <div class="layout">

    <aside class="sidebar">
      <div class="brand">User</div>
      <nav class="nav">
        <a class="active" href="#">Dashboard</a>
      </nav>

      <form method="POST" action="{{ url_for('logout') }}">
        <button class="btn-save" style="width:100%; margin-top:16px;">Logout</button>
      </form>
    </aside>

    <main class="content">
      <div class="topbar">
        <h1>Dashboard</h1>
        <div style="color:var(--muted); font-weight:800; font-size:13px;">
          Last update: {{ last_global_update or "‚Äî" }}
        </div>
      </div>

      <div class="search-wrap">
        <form class="search-row" method="POST" action="{{ url_for('add_item') }}">
          <input name="item" class="search-input" placeholder="Paste Amazon.sa link or ASIN..." required />
          <button class="btn-glow" type="submit">Add</button>
        </form>
      </div>

      <div class="grid">

        <!-- MARKETING CARD -->
        <section class="card marketing-card">
          <div class="marketing-head">
            <div>
              <p class="marketing-title" style="margin:0;">Top Deals</p>
              <div class="marketing-sub">5 deals rotate every update</div>
            </div>
          </div>

          <div class="marketing-list" id="marketingList">
            <!-- filled by JS -->
          </div>
        </section>

        <!-- USER ITEMS -->
        {% for it in items %}
        <section class="card item-card" data-asin="{{ it.asin }}">
          <h3 class="title">{{ it.title or it.asin }}</h3>

          <div class="meta-row">
            <div class="price">{{ it.current_price_text or "‚Äî" }}</div>

            {% if it.lowest_price_text %}
              <span class="pill low">L: {{ it.lowest_price_text }}</span>
            {% endif %}
            {% if it.highest_price_text %}
              <span class="pill high">H: {{ it.highest_price_text }}</span>
            {% endif %}

            {% if it.is_low and not it.is_flat %}
              <span class="pill low">üî• Low</span>
            {% endif %}

            {% if it.coupon_text %}
              <span class="pill coupons">üéüÔ∏è {{ it.coupon_text }}</span>
            {% endif %}
          </div>

          <div class="chart-box">
            <canvas id="chart_{{ it.asin }}"></canvas>
          </div>

          <div class="actions">
            <form class="target-form" method="POST" action="{{ url_for('set_target_price', asin=it.asin) }}">
              <span class="target-label">Target price:</span>
              <input class="target-input" type="number" step="0.01" name="target_price" value="{{ it.target_price or '' }}" />
              <button class="btn-save" type="submit">üíæ</button>
            </form>

            <a class="btn-del" href="{{ url_for('delete_item', asin=it.asin) }}">Delete</a>
          </div>
        </section>
        {% endfor %}

      </div>
    </main>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>

  <script>
    const charts = {};

    async function loadHistoryAndRender(asin){
      const res = await fetch(`/history/${asin}.json?t=${Date.now()}`);
      const data = await res.json();

      const labels = data.map(r => r.ts_label || r.ts || "");
      const values = data.map(r => Number(r.price_value ?? r.price ?? 0)).filter(v => !Number.isNaN(v));

      const ctx = document.getElementById(`chart_${asin}`);
      if(!ctx) return;

      if(charts[asin]) charts[asin].destroy();

      // If only one point, place it in the middle (simple trick: duplicate with nulls)
      let plotLabels = labels;
      let plotValues = values;
      if(values.length === 1){
        plotLabels = ["", labels[0], ""];
        plotValues = [null, values[0], null];
      }

      charts[asin] = new Chart(ctx, {
        type: "line",
        data: {
          labels: plotLabels,
          datasets: [{
            label: asin,
            data: plotValues,
            tension: 0.3,
            fill: true
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: { legend: { display: false } },
          scales: {
            y: {
              position: "left",
              ticks: { color: "#bdbde9" },
              grid: { color: "rgba(255,255,255,0.06)" }
            },
            x: {
              ticks: { color: "#bdbde9" },
              grid: { color: "rgba(255,255,255,0.04)" }
            }
          }
        }
      });
    }

    async function initCharts(){
      const cards = document.querySelectorAll(".item-card");
      for(const c of cards){
        const asin = c.dataset.asin;
        await loadHistoryAndRender(asin);
      }
    }

    function renderMarketingBanners() {
      const list = document.getElementById("marketingList");
      if(!list) return;

      // DON'T show banners for items the user already has
      const tracked = new Set({{ items|map(attribute="asin")|list|tojson }});
      const deals = ({{ marketing_items|tojson }} || [])
        .filter(d => d && d.asin && !tracked.has(d.asin))
        .slice(0, 5);

      list.innerHTML = "";

      if(!deals.length){
        list.innerHTML = `<div style="color:#bdbde9; font-weight:800; padding:10px;">No marketing deals right now</div>`;
        return;
      }

      for (const d of deals) {
        const el = document.createElement("div");
        el.className = "deal-banner";
        el.innerHTML = `
          <div class="deal-content">
            <div class="deal-left">
              <div class="deal-name">${d.title || d.asin}</div>
              <div class="deal-price">${d.price_text || ""}</div>
            </div>
            <div class="deal-right">
              <div class="deal-discount">${d.discount_text || ""}</div>
              <button class="deal-add-btn" type="button" data-asin="${d.asin}">add</button>
            </div>
          </div>
        `;
        list.appendChild(el);
      }

      // add button action (auto-fill input + submit)
      list.querySelectorAll(".deal-add-btn").forEach(btn => {
        btn.addEventListener("click", () => {
          const asin = btn.getAttribute("data-asin") || "";
          const input = document.querySelector("input[name='item']");
          if(input){
            input.value = asin;
            input.form?.submit();
          }
        });
      });
    }

    document.addEventListener("DOMContentLoaded", async () => {
      renderMarketingBanners();
      await initCharts();
    });
  </script>
</body>
</html>
