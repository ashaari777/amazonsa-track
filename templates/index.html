<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Dashboard</title>

  <style>
    :root{
      --bg0:#0b0b18;
      --bg1:#11112a;
      --card:#1a1a36;
      --card2:#202048;
      --stroke:rgba(255,255,255,.08);
      --text:#f3f4ff;
      --muted:rgba(255,255,255,.65);
      --accent:#ff4d6d;
      --good:#29d3a3;
      --warn:#ffb14a;
      --bad:#ff4d6d;
      --radius:22px;
      --shadow: 0 18px 50px rgba(0,0,0,.35);
      --card-h: 520px;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
      color:var(--text);
      background: radial-gradient(1200px 700px at 60% 20%, rgba(120,90,255,.22), transparent 60%),
                  radial-gradient(900px 550px at 30% 80%, rgba(255,77,109,.12), transparent 60%),
                  linear-gradient(180deg, var(--bg0), var(--bg1));
      min-height:100vh;
    }
    .layout{display:flex; min-height:100vh;}
    .sidebar{
      width:240px;
      padding:22px 16px;
      border-right:1px solid rgba(255,255,255,.06);
      background: linear-gradient(180deg, rgba(255,255,255,.02), rgba(0,0,0,.08));
    }
    .side-title{font-weight:800; opacity:.9; margin:0 0 14px 8px;}
    .navbtn{
      display:block;
      width:100%;
      text-align:left;
      padding:12px 14px;
      border-radius:14px;
      border:1px solid rgba(255,255,255,.08);
      color:var(--text);
      background: rgba(255,255,255,.03);
      margin-bottom:10px;
      font-weight:700;
    }
    .navbtn.active{outline:2px solid rgba(255,193,7,.35); border-color:rgba(255,193,7,.35);}
    .logout{
      position:fixed;
      left:16px;
      bottom:18px;
      width:208px;
      padding:10px 14px;
      border-radius:14px;
      background: rgba(255,255,255,.04);
      border:1px solid rgba(255,255,255,.08);
      color:rgba(255,255,255,.85);
      font-weight:700;
    }

    .content{flex:1; padding:26px 22px;}
    .container{max-width:1300px; margin:0 auto;}
    .topbar{
      display:flex; align-items:center; justify-content:space-between;
      margin-bottom:14px;
    }
    .topbar h1{margin:0; font-size:28px; letter-spacing:.2px;}
    .updated{font-size:12px; opacity:.6}

    .addbar{
      display:flex;
      gap:10px;
      padding:12px;
      border-radius:18px;
      background: rgba(255,255,255,.03);
      border:1px solid rgba(255,255,255,.07);
      box-shadow: 0 10px 30px rgba(0,0,0,.22);
      margin-bottom:14px;
      align-items:center;
    }
    .addbar input{
      flex:1;
      height:44px;
      border-radius:14px;
      border:1px solid rgba(255,255,255,.08);
      background: rgba(0,0,0,.18);
      color:var(--text);
      padding:0 14px;
      outline:none;
      font-weight:600;
    }
    .addbar button{
      height:44px;
      min-width:92px;
      border-radius:14px;
      border:0;
      cursor:pointer;
      color:#111;
      font-weight:900;
      background: linear-gradient(90deg, #ff4d6d, #ffb14a);
      box-shadow: 0 10px 24px rgba(255,77,109,.22);
    }

    .grid{
      display:grid;
      grid-template-columns: repeat(6, minmax(0,1fr));
      gap:16px;
      align-items:stretch;
    }
    @media (max-width:1200px){
      .sidebar{display:none}
      .layout{display:block}
      .grid{grid-template-columns: repeat(2, minmax(0,1fr));}
    }
    @media (max-width:720px){
      .grid{grid-template-columns: 1fr;}
    }

    .card{
      background: radial-gradient(900px 520px at 40% 15%, rgba(255,255,255,.06), transparent 55%),
                  linear-gradient(180deg, rgba(255,255,255,.02), rgba(0,0,0,.10));
      border:1px solid rgba(255,255,255,.08);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      overflow:hidden;
      position:relative;
      min-height: var(--card-h);
    }

    /* ------- existing banner styles from index_with_marketing.html ------- */
    .marketing-wrap{margin:0 0 16px 0;}
    .marketing-inner{
      background: rgba(255,255,255,.03);
      border:1px solid rgba(255,255,255,.07);
      border-radius:18px;
      padding:14px;
    }
    .marketing-head{
      display:flex; align-items:flex-end; justify-content:space-between;
      margin:0 0 10px 0;
    }
    .marketing-title{font-weight:900; font-size:14px;}
    .marketing-hint{font-size:12px; opacity:.6}

    .deal-banner{
      position:relative;
      border-radius:16px;
      overflow:hidden;
      background: linear-gradient(180deg, rgba(255,216,120,.78), rgba(255,190,80,.55));
      border:1px solid rgba(255,255,255,.28);
      box-shadow: 0 10px 22px rgba(0,0,0,.25);
    }
    .deal-banner::before{
      content:"";
      position:absolute; inset:8px;
      border-radius:12px;
      border:2px dashed rgba(255,120,0,.55);
      pointer-events:none;
    }
    .deal-notch{
      position:absolute;
      top:18px;
      width:30px; height:60px;
      background: linear-gradient(180deg, #ff4d3b, #ff2b5c);
      filter: drop-shadow(0 8px 14px rgba(0,0,0,.25));
      opacity:.9;
    }
    .deal-notch.left{left:0; border-radius:0 18px 18px 0;}
    .deal-notch.right{right:0; border-radius:18px 0 0 18px;}
    .deal-body{
      position:relative;
      z-index:2;
      display:grid;
      grid-template-columns: 1fr 190px;
      gap:12px;
      height:100%;
      padding:12px 14px;
      align-items:center;
    }
    .deal-left{
      min-width:0;
      display:flex;
      flex-direction:column;
      gap:6px;
      padding-left:6px;
    }
    .deal-title{
      font-weight:900;
      font-size:12px;
      color: rgba(10,10,10,.85);
    }
    .deal-price{
      font-weight:900;
      font-size:14px;
      color: rgba(10,10,10,.88);
    }
    .deal-mid{
      display:flex;
      align-items:center;
      justify-content:flex-end;
      gap:10px;
      padding-right:6px;
    }
    .deal-divider{
      width:2px;
      height:44px;
      background: rgba(255,120,0,.6);
      border-radius:4px;
    }
    .deal-off{
      display:flex;
      align-items:flex-end;
      gap:3px;
      font-weight:1000;
      color: rgba(10,10,10,.90);
    }
    .deal-off .n{font-size:44px; line-height:1;}
    .deal-off .pct{
      font-size:18px;
      line-height:1.2;
      background: #ff8a00;
      color:#fff;
      width:26px; height:26px;
      display:grid; place-items:center;
      border-radius:50%;
      transform: translateY(-6px);
      box-shadow: 0 10px 18px rgba(0,0,0,.18);
      font-weight:1000;
    }
    .deal-footer{
      position:absolute;
      left:0; right:0;
      bottom:10px;
      display:flex;
      align-items:center;
      justify-content:center;
      z-index:3;
      pointer-events:none;
    }
    .deal-add-btn{
      pointer-events:auto;
      height:26px;
      min-width:74px;
      border-radius:14px;
      border:0;
      cursor:pointer;
      font-weight:900;
      color:#fff;
      background: linear-gradient(90deg, #ff7a00, #ffb14a);
      box-shadow: 0 10px 20px rgba(0,0,0,.25);
      text-transform:lowercase;
    }

    /* --- Marketing card (Top deals) --- */
    .marketing-card{
      display:flex;
      flex-direction:column;
      height: var(--card-h, 520px);
      min-height: 520px;
      overflow:hidden;
    }
    .mkt-card-head{
      display:flex;
      align-items:flex-end;
      justify-content:space-between;
      padding:10px 12px 8px 12px;
      border-bottom:1px solid rgba(255,255,255,.06);
    }
    .mkt-head-title{font-weight:800; font-size:14px; letter-spacing:.2px;}
    .mkt-head-sub{font-size:11px; opacity:.75; margin-top:2px;}
    .mkt-head-right{font-size:11px; opacity:.6;}
    .marketing-list{
      display:flex;
      flex-direction:column;
      gap:10px;
      padding:10px 12px 12px 12px;
      flex:1;
      min-height:0;
    }
    .marketing-list .deal-banner{
      flex:1;
      min-height:0;
      width:100%;
    }
    .marketing-list .deal-title{
      overflow:hidden;
      text-overflow:ellipsis;
      white-space:nowrap;
      max-width:100%;
    }
    .deal-add-btn{
      opacity:1 !important;
      filter: drop-shadow(0 6px 14px rgba(0,0,0,.35));
    }
    .deal-add-btn:hover{opacity:1 !important;}
    .deal-meta{display:none !important;}

    /* Cards content (your existing styles continue below in your original file) */
    .card-inner{padding:14px 14px 12px 14px;}
    .item-title{
      margin:0 0 10px 0;
      font-size:13px;
      font-weight:900;
      line-height:1.2;
      min-height:34px;
    }
    .meta-row{
      display:flex;
      align-items:center;
      gap:8px;
      flex-wrap:wrap;
      margin-bottom:10px;
    }
    .pill{
      display:inline-flex;
      align-items:center;
      gap:6px;
      padding:6px 10px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.03);
      font-weight:800;
      font-size:11px;
      color: rgba(255,255,255,.86);
    }
    .pill.good{border-color: rgba(41,211,163,.35); color: rgba(41,211,163,.95);}
    .pill.bad{border-color: rgba(255,77,109,.35); color: rgba(255,77,109,.95);}
    .pill.warn{border-color: rgba(255,177,74,.35); color: rgba(255,177,74,.95);}
    .pill.low{border-color: rgba(255,177,74,.35); color: rgba(255,177,74,.95);}
    .coupon-row{display:flex; gap:8px; flex-wrap:wrap; margin-bottom:10px;}
    .chart-wrap{height:260px; margin-top:6px;}
    canvas{width:100% !important; height:100% !important;}
    .card-footer{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      padding:12px 14px 14px 14px;
      border-top:1px solid rgba(255,255,255,.06);
    }
    .target-form{display:flex; gap:8px; align-items:center;}
    .target-form input{
      width:140px;
      height:34px;
      border-radius:10px;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(0,0,0,.22);
      color: rgba(255,255,255,.90);
      padding:0 10px;
      font-weight:800;
      outline:none;
    }
    .target-form button{
      height:34px;
      border-radius:10px;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.05);
      color: rgba(255,255,255,.9);
      font-weight:900;
      cursor:pointer;
      padding:0 10px;
    }
    .delete-link{
      color:#ff4d6d;
      font-weight:900;
      text-decoration:none;
      cursor:pointer;
    }
  </style>

  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
</head>

<body>
  <div class="layout">
    <aside class="sidebar">
      <div class="side-title">User</div>
      <button class="navbtn active">Dashboard</button>

      <form method="POST" action="{{ url_for('logout') }}">
        <button class="logout" type="submit">Log Out</button>
      </form>
    </aside>

    <main class="content">
      <div class="container">
        <div class="topbar">
          <h1>Dashboard</h1>
          <div class="updated">Updated: {{ (last_global_update or "") }}</div>
        </div>

        <form class="addbar" method="POST" action="{{ url_for('add_item') }}">
          <input name="q" placeholder="Paste Amazon.sa link or ASIN..." autocomplete="off" />
          <button type="submit">Add</button>
        </form>

        <div class="grid">
          <!-- MARKETING CARD (Top 5 deals) ‚Äî same width/height as a normal item card -->
          <div class="card marketing-card" id="marketing-wrap">
            <div class="mkt-card-head">
              <div class="mkt-head-left">
                <div class="mkt-head-title">Top deals right now</div>
                <div class="mkt-head-sub">Tap ‚Äúadd‚Äù to monitor</div>
              </div>
              <div class="mkt-head-right">Top 5</div>
            </div>
            <div id="marketing-list" class="marketing-list" aria-label="Top deals"></div>
          </div>

          {% for it in items %}
          <div class="card">
            <div class="card-inner">
              <h3 class="item-title">{{ it.title }}</h3>

              <div class="meta-row">
                <span class="pill good">{{ it.price_text }}</span>
                <span class="pill good">L: {{ it.lowest_price_text }}</span>
                <span class="pill bad">H: {{ it.highest_price_text }}</span>

                {% if it.is_low %}
                  <span class="pill low">üî• Low</span>
                {% endif %}
              </div>

              {% if it.coupon_text %}
              <div class="coupon-row">
                <span class="pill warn">üéü</span>
                <span class="pill good">{{ it.coupon_text }}</span>
              </div>
              {% endif %}

              <div class="chart-wrap">
                <canvas id="c_{{ it.asin }}"></canvas>
              </div>
            </div>

            <div class="card-footer">
              <form class="target-form" method="POST" action="{{ url_for('set_target_price', asin=it.asin) }}">
                <span class="pill" style="padding:6px 10px; opacity:.8;">Target price:</span>
                <input name="target_price" value="{{ it.target_price or '' }}" placeholder="" />
                <button type="submit">Save</button>
              </form>

              <form method="POST" action="{{ url_for('delete_item', asin=it.asin) }}">
                <button type="submit" class="delete-link" style="background:none;border:none;">Delete</button>
              </form>
            </div>
          </div>
          {% endfor %}
        </div>
      </div>
    </main>
  </div>

  <script>
    function escapeHtml(s){
      return String(s ?? "")
        .replaceAll("&","&amp;").replaceAll("<","&lt;")
        .replaceAll(">","&gt;").replaceAll('"',"&quot;")
        .replaceAll("'","&#039;");
    }
    function normalizeAsin(q){
      const s = String(q||"").trim();
      const m = s.match(/([A-Z0-9]{10})/i);
      return m ? m[1].toUpperCase() : "";
    }
    async function quickAddAsin(asin){
      const a = normalizeAsin(asin);
      if(!a) return;
      try{
        await fetch("{{ url_for('add_item') }}", {
          method:"POST",
          headers: {"Content-Type":"application/x-www-form-urlencoded"},
          body: new URLSearchParams({q:a}).toString()
        });
        location.reload();
      }catch(e){}
    }

    // USER's current monitored ASINs (so marketing won't show the same items)
    const userAsins = new Set({{ items|map(attribute="asin")|list|tojson }});

    // Marketing items from backend (if your app.py provides it). If not, it falls back safely.
    const marketingMeta = (
      {% if marketing_items is defined %}{{ marketing_items|tojson }}{% else %}[]{% endif %}
    ) || [];

    const marketingSource = (marketingMeta.length ? marketingMeta : [
      {%- for it in items %}
      {asin:"{{ it.asin }}", title: {{ (it.title or "")|tojson }}, price_text: {{ (it.price_text or "")|tojson }}, discount_percent: {{ (it.discount_percent or 0)|int }}},
      {%- endfor %}
    ]);

    function pickLabelPrice(d){
      const p = (d.price_text || d.price || d.current_price_text || "").toString().trim();
      if(p) return p;
      const v = d.price_value ?? d.current_price_value;
      return (v != null) ? ("SAR " + Number(v).toFixed(2)) : "SAR XX.XX";
    }

    function renderMarketingBanners(){
      const wrap = document.getElementById("marketing-wrap");
      const list = document.getElementById("marketing-list");
      if(!wrap || !list) return;

      // exclude user's own items
      const deals = marketingSource
        .filter(d => d && d.asin && !userAsins.has(d.asin))
        .map(d => ({
          asin: String(d.asin || "").toUpperCase(),
          title: String(d.title || d.product_title || "").trim() || "Deal item",
          price_text: String(pickLabelPrice(d)),
          discount_percent: Number(d.discount_percent || d.discount || d.badge_percent || 0) || 0
        }))
        .filter(d => d.asin && d.title);

      // sort by highest discount
      deals.sort((a,b)=> (b.discount_percent||0) - (a.discount_percent||0));

      // take top 5
      const top = deals.slice(0,5);

      // if fewer than 5, show placeholders (but still keep layout consistent)
      while(top.length < 5){
        top.push({asin:"", title:"More deals will appear here", price_text:"", discount_percent:0});
      }

      list.innerHTML = top.map(d => {
        const pct = (d.discount_percent && d.discount_percent > 0) ? d.discount_percent : 0;
        const safeTitle = escapeHtml(d.title);
        const safePrice = escapeHtml(d.price_text || "SAR XX.XX");
        const pctText = escapeHtml(pct ? String(pct) : "0");

        const addBtn = d.asin
          ? `<button class="deal-add-btn" onclick="quickAddAsin('${d.asin}')">add</button>`
          : `<button class="deal-add-btn" disabled style="opacity:.55; cursor:not-allowed;">add</button>`;

        return `
          <div class="deal-banner">
            <div class="deal-notch left"></div>
            <div class="deal-notch right"></div>

            <div class="deal-body">
              <div class="deal-left">
                <div class="deal-title">${safeTitle}</div>
                <div class="deal-price">${safePrice}</div>
              </div>

              <div class="deal-mid">
                <div class="deal-divider"></div>
                <div class="deal-off">
                  <div class="n">${pctText}</div>
                  <div class="pct">%</div>
                </div>
              </div>
            </div>

            <div class="deal-footer">${addBtn}</div>
          </div>
        `;
      }).join("");
    }

    async function loadHistory(asin){
      const url = `/history/${asin}.json?t=${Date.now()}`;
      const r = await fetch(url);
      if(!r.ok) return [];
      return await r.json();
    }

    function buildChart(asin, points){
      const el = document.getElementById(`c_${asin}`);
      if(!el) return;

      const labels = points.map(p => p.ts_label || p.ts || "");
      const values = points.map(p => Number(p.price_value ?? p.price ?? 0));

      new Chart(el, {
        type: "line",
        data: {
          labels,
          datasets: [{
            data: values,
            tension: .28,
            fill: true,
            borderWidth: 2,
            pointRadius: 0
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: { display:false },
            tooltip: { enabled:true }
          },
          scales: {
            x: {
              ticks: { color: "rgba(255,255,255,.5)", maxRotation:0, autoSkip:true },
              grid: { color:"rgba(255,255,255,.05)" }
            },
            y: {
              position: "left",
              ticks: { color: "rgba(255,255,255,.55)" },
              grid: { color:"rgba(255,255,255,.06)" }
            }
          }
        }
      });
    }

    (async () => {
      renderMarketingBanners();

      const asins = {{ items|map(attribute="asin")|list|tojson }};
      for (const asin of asins) {
        try {
          const points = await loadHistory(asin);
          buildChart(asin, points || []);
        } catch (e) {}
      }
    })();
  </script>
</body>
</html>
